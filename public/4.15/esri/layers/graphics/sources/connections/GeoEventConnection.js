// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../geometry ../../../../request ../../../../core/Error ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../FeatureLayer ./StreamConnection ../../../../tasks/operations/query ../../../../tasks/operations/zscale ../../../../tasks/support/Query".split(" "),
function(x,r,q,v,l,z,A,B,p,C,h,w,u,D,E,y,F,G){Object.defineProperty(r,"__esModule",{value:!0});var m=C.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),t;(function(h){h[h.CONNECTING=0]="CONNECTING";h[h.OPEN=1]="OPEN";h[h.CLOSING=2]="CLOSING";h[h.CLOSED=3]="CLOSED"})(t=r.ReadyState||(r.ReadyState={}));x=function(r){function d(a,c,b,e,g,f,d,h){void 0===f&&(f=5);void 0===d&&(d=3);var k=r.call(this)||this;k._destroyed=!1;k.errorString=null;k._source=a;k._sourceSpatialReference=
c;k._spatialReference=b;k._filter=g;k._outFields=h;k._maxQueryDepth=f;k._maxRecordCountFactor=d;k._featureZScaler=F.getGeometryZScaler(e,c,b);k._open();return k}z(d,r);d.prototype._open=function(){return l(this,void 0,void 0,function(){var a,c,b,e;return q(this,function(g){switch(g.label){case 0:return[4,this._fetchServiceDefinition(this._source)];case 1:return a=g.sent(),a.timeInfo.trackIdField||m.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),
[4,this._fetchWebSocketUrl(a.streamUrls,this._spatialReference)];case 2:return c=g.sent(),this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),[4,this._buddyServicesQuery];case 3:return g.sent(),[4,this._tryCreateWebSocket(c)];case 4:return g.sent(),b=this._filter,e=this._outFields,this._destroyed||this._setFilter(b,e),[2]}})})};d.prototype.destroy=function(){this._destroyed=!0;h.isSome(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=
null,this._websocket.onmessage=null,this._websocket.close());this._websocket=null};Object.defineProperty(d.prototype,"connectionStatus",{get:function(){if(h.isNone(this._websocket))return"disconnected";switch(this._websocket.readyState){case t.CONNECTING:case t.OPEN:return"connected";case t.CLOSING:case t.CLOSED:return"disconnected"}},enumerable:!0,configurable:!0});d.prototype._tryCreateWebSocket=function(a,c){void 0===c&&(c=1E3);return l(this,void 0,void 0,function(){var b,e,g;return q(this,function(f){switch(f.label){case 0:f.trys.push([0,
2,,4]);if(this._destroyed)return[2];b=this;return[4,this._createWebSocket(a)];case 1:return b._websocket=f.sent(),this.notifyChange("connectionStatus"),[3,4];case 2:return e=f.sent(),g=c/1E3,m.error(new p("geoevent-connection","Failed to connect. Attempting to reconnect in "+g+"s",e)),[4,w.after(c)];case 3:return f.sent(),[2,this._tryCreateWebSocket(a,1.5*c)];case 4:return[2]}})})};d.prototype._createWebSocket=function(a){var c=this,b=new WebSocket(a);a=w.create(function(a,c){b.onopen=function(){return a(b)};
b.onclose=function(a){return c(a)}});a.then(function(){c._destroyed?(b.onclose=function(){},b.close()):(b.onclose=function(a){return c._onClose(a)},b.onerror=function(a){return c._onError(a)},b.onmessage=function(a){return c._onMessage(a)})});return a};d.prototype._onMessage=function(a){var c;try{c=this._enrich(JSON.parse(a.data)),this._featureZScaler&&this._featureZScaler(c.geometry)}catch(b){m.error(new p("geoevent-connection","Failed to parse message",b));return}this.onFeature(c)};d.prototype._onError=
function(a){this._set("errorString","Encountered an error over WebSocket connection");m.error("geoevent-connection","Encountered an error over WebSocket connection")};d.prototype._onClose=function(a){this._websocket=null;this.notifyChange("connectionStatus");1E3!==a.code&&m.error("geoevent-connection","WebSocket closed unexpectedly with error code "+a.code);this._destroyed||this._open()};d.prototype._fetchServiceDefinition=function(a){return l(this,void 0,void 0,function(){var c,b,e,g;return q(this,
function(f){switch(f.label){case 0:return c={f:"json"},b=B(a,{query:c,responseType:"json"}),[4,b];case 1:return e=f.sent(),this._serviceDefinition=g=e.data,[2,g]}})})};d.prototype._fetchWebSocketUrl=function(a,c){return l(this,void 0,void 0,function(){var b,e,g,f;return q(this,function(d){b=a[0];e=b.urls;g=b.token;f=this._inferWebSocketBaseUrl(e);return[2,f+"/subscribe?outSR\x3d"+c.wkid+(g?"\x26token\x3d"+g:"")]})})};d.prototype._inferWebSocketBaseUrl=function(a){if(1===a.length)return a[0];for(var c=
0;c<a.length;c++){var b=a[c];if(-1!==b.indexOf("wss"))return b}m.error(new p("geoevent-connection","Unable to infer WebSocket url",a));return null};d.prototype._setFilter=function(a,c){return l(this,void 0,void 0,function(){var b,e,g,f,d,l,k=this;return q(this,function(n){b=this._websocket;this._filter=a;this._outFields=c;if(h.isNone(b)||h.isNone(a)&&h.isNone(c))return[2];e=JSON.stringify({filter:this._serializeFilter(a,c)});g=!1;f=w.createResolver();d=function(){g||(k._destroyed||k._websocket!==
b||m.error(new p("geoevent-connection","Server timed out when setting filter")),f.reject())};l=function(a){a=JSON.parse(a.data);a.filter&&(a.error&&(m.error(new p("geoevent-connection","Failed to set service filter",a.error)),k._set("errorString","Could not set service filter - "+a.error),f.reject(a.error)),b.onmessage=k._onMessage.bind(k),g=!0,f.resolve())};b.onmessage=l;b.send(e);setTimeout(d,1E4);return[2,f.promise]})})};d.prototype._serializeFilter=function(a,c){var b={};if(h.isNone(a)&&h.isNone(c))return b;
if(h.isSome(a)&&a.geometry)try{var e=A.fromJSON(a.geometry);if("extent"!==e.type)throw new p("Expected extent but found type "+e.type);b.geometry=JSON.stringify(e.shiftCentralMeridian())}catch(g){m.error(new p("geoevent-connection","Encountered an error when setting connection geometryDefinition",g))}h.isSome(a)&&a.where&&"1 \x3d 1"!==a.where&&(b.where=a.where);h.isSome(c)&&(b.outFields=c.join(","));return b};d.prototype._enrich=function(a){if(!this._relatedFeatures)return a;var c=a.attributes[this._serviceDefinition.relatedFeatures.joinField];
if(!this._relatedFeatures.has(c))return m.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",a),a;var b=this._relatedFeatures.get(c),c=b.attributes,b=b.geometry,e;for(e in c)a.attributes[e]=c[e];b&&(a.geometry=b);a.geometry||a.centroid||m.error(new p("geoevent-connection","Found malformed feature - no geometry found",a));return a};d.prototype._queryBuddyServices=function(){return l(this,void 0,void 0,function(){var a,c,b,e,g,d,h,l,k,n;return q(this,function(f){switch(f.label){case 0:return f.trys.push([0,
3,,4]),a=this._serviceDefinition,c=a.relatedFeatures,b=a.keepLatestArchive,e=this._queryRelatedFeatures(c),g=this._queryArchive(b),[4,e];case 1:return f.sent(),[4,g];case 2:d=f.sent();if(!d)return[2];h=0;for(l=d.features;h<l.length;h++)k=l[h],this.onFeature(this._enrich(k));return[3,4];case 3:return n=f.sent(),m.error(new p("geoevent-connection","Encountered an error when querying buddy services",{error:n})),[3,4];case 4:return[2]}})})};d.prototype._queryRelatedFeatures=function(a){return l(this,
void 0,void 0,function(){var c;return q(this,function(b){switch(b.label){case 0:return a?[4,this._queryBuddy(a.featuresUrl)]:[2];case 1:return c=b.sent(),this._addRelatedFeatures(c),[2]}})})};d.prototype._queryArchive=function(a){return l(this,void 0,void 0,function(){return q(this,function(c){return a?[2,this._queryBuddy(a.featuresUrl)]:[2,void 0]})})};d.prototype._queryBuddy=function(a){return l(this,void 0,void 0,function(){var c,b,e,g,d,l,m,k,n,p;return q(this,function(f){switch(f.label){case 0:return c=
new D({url:a}),[4,c.load()];case 1:return b=f.sent().capabilities,e=b.query.supportsMaxRecordCountFactor,g=b.query.supportsPagination,d=b.query.supportsCentroid,l=this._maxRecordCountFactor,m=c.capabilities.query.maxRecordCount,k=e?m*l:m,n=new G,n.outFields=h.unwrapOr(this._outFields,["*"]),n.where=h.unwrapOr(h.get(this._filter,"where"),"1\x3d1"),n.returnGeometry=!0,n.returnExceededLimitFeatures=!0,n.outSpatialReference=this._spatialReference,d&&(n.returnCentroid=!0),e&&(n.maxRecordCountFactor=l),
g?(n.num=k,c.destroy(),[2,this._queryPages(a,n)]):[4,y.executeQuery(a,n,this._sourceSpatialReference)];case 2:return p=f.sent(),c.destroy(),[2,p.data]}})})};d.prototype._queryPages=function(a,c,b,e){void 0===b&&(b=[]);void 0===e&&(e=0);return l(this,void 0,void 0,function(){var d;return q(this,function(f){switch(f.label){case 0:return c.start=e*c.num,[4,y.executeQuery(a,c,this._sourceSpatialReference)];case 1:d=f.sent().data;if(d.exceededTransferLimit&&e<this._maxQueryDepth)return d.features.forEach(function(a){return b.push(a)}),
[2,this._queryPages(a,c,b,e+1)];b.forEach(function(a){return d.features.push(a)});return[2,d]}})})};d.prototype._addRelatedFeatures=function(a){var c=new Map,b=this._serviceDefinition.relatedFeatures.joinField,d=0;for(a=a.features;d<a.length;d++){var g=a[d];c.set(g.attributes[b],g)}this._relatedFeatures=c};v([u.property()],d.prototype,"connectionStatus",null);v([u.property()],d.prototype,"errorString",void 0);return d=v([u.subclass("esri.layers.graphics.sources.connections.GeoEventConnection")],d)}(u.declared(E.default));
r.default=x});