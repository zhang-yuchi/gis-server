// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/declareExtendsHelper ../../../geometry ../../../Graphic ../../../core/Evented ../../../core/HandleOwner ../../../core/Promise ../../../core/accessorSupport/decorators ../data/StreamFeatureManager ../sources/connections/GeoEventConnection ../../../views/3d/support/EventedSet".split(" "),function(g,h,f,k,m,l,n,p,q,e,r,t,u){Object.defineProperty(h,"__esModule",{value:!0});var v=function(){function c(a,d){this.layer=
a;this.collection=d;this._idToGraphic=new Map;this._idToFeature=new Map}c.prototype.destroy=function(){this._idToGraphic.clear();this._idToFeature.clear()};c.prototype.add=function(a){var d=l.fromJSON(a);d.sourceLayer=d.layer=this.layer;this._idToFeature.set(a.objectId,a);this._idToGraphic.set(a.objectId,d);this.collection.addMany([d])};c.prototype.forEach=function(a){this._idToFeature.forEach(a)};c.prototype.removeById=function(a){var d=this._idToFeature.get(a),b=this._idToGraphic.get(a);if(!d||
!b)return null;b.sourceLayer=b.layer=null;this.collection.remove(b);this._idToFeature.delete(a);this._idToGraphic.delete(a);return d};c.prototype.update=function(a,d){};Object.defineProperty(c.prototype,"size",{get:function(){return this.collection.length},enumerable:!0,configurable:!0});return c}();g=function(c){function a(){var a=null!==c&&c.apply(this,arguments)||this;a.graphics=new u.EventedSet;return a}k(a,c);a.prototype.initialize=function(){var a=this;this.addResolvingPromise(this.layer.when(function(){return a._startup()}))};
a.prototype.destroy=function(){this.clear()};a.prototype.clear=function(){this._updateIntervalId&&(clearInterval(this._updateIntervalId),this._updateIntervalId=0);this.connection&&(this.connection.destroy(),this.connection=null);this.store&&(this.store.destroy(),this.store=null);this.graphics.clear();this.handles.removeAll()};Object.defineProperty(a.prototype,"updating",{get:function(){return!this.connection||"connected"===this.connection.connectionStatus},enumerable:!0,configurable:!0});a.prototype._startup=
function(){var a=this,b=this.layer,c=b.parsedUrl,e=b.spatialReference,f=b.definitionExpression,g=b.geometryDefinition,h=b.objectIdField,k=b.timeInfo,b=b.purgeOptions,l=m.featureGeometryTypeKebabDictionary.toJSON(this.layer.geometryType);this.clear();this._set("connection",new t.default(c.path,e,this.layerView.view.spatialReference,l,{geometry:g,where:f}));this.store=new v(this.layer,this.graphics);this.featuresManager=new r.default(this.store,h,k.toJSON(),b);this.handles.add([this.connection.on("feature",
function(d){return a._onFeature(d)}),this.layer.watch("definitionExpression",function(){return a._startup()}),this.layer.watch("geometryDefinition",function(){return a._startup()}),this.layer.watch("purgeOptions",function(){return a._startup()})]);this._updateIntervalId=setInterval(function(){return a.featuresManager.checkForUpdates()},64)};a.prototype._onFeature=function(a){this.emit("data-received",{attributes:a.attributes,centroid:a.centroid,geometry:a.geometry});try{this.featuresManager.add(a)}catch(b){}};
f([e.property()],a.prototype,"connection",void 0);f([e.property()],a.prototype,"layer",void 0);f([e.property()],a.prototype,"layerView",void 0);f([e.property({readOnly:!0,dependsOn:["connection.connectionStatus"]})],a.prototype,"updating",null);return a=f([e.subclass("esri.layers.graphics.controllers.StreamController")],a)}(e.declared(p.HandleOwnerMixin(q.EsriPromiseMixin(n.EventedAccessor))));h.default=g});