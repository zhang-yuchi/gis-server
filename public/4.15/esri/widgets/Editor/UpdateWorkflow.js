// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/generatorHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/awaiterHelper ../../core/tsSupport/declareExtendsHelper ../../core/arrayUtils ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../views/support/layerViewUtils ./Edits ./UpdateWorkflowData ./Workflow ./workflowUtils".split(" "),function(E,F,e,w,c,x,y,l,z,g,A,B,C,D,n){return function(p){function d(a){a=p.call(this,a)||this;a.type="update";return a}
x(d,p);h=d;d.create=function(a,e,b){a=new C({edits:new B,viewModel:a});b=new h({data:a,afterCommit:b});b._set("steps",this._createWorkflowSteps(b,e));return b};d.prototype.highlight=function(a){var e=this.data.viewModel.view,e=a&&y.find(e.allLayerViews.items,function(b){return b.layer===a.layer});A.highlightsSupported(e)&&this.handles.add(e.highlight(a),"candidate-highlight")};d.prototype.unhighlight=function(){this.handles.remove("candidate-highlight")};d._createWorkflowSteps=function(a,d){void 0===
d&&(d="awaiting-feature-to-update");var b=a.data,k=a.handles,h={"awaiting-feature-to-update":function(){return{id:"awaiting-feature-to-update",setUp:function(){return c(this,void 0,void 0,function(){var a,f,d,c,g;return e(this,function(e){a=b.viewModel;f=a.spinnerViewModel;d=a.view;c=null;k.add({remove:function(){c&&(c.abort(),c=null)}},this.id);b.edits.feature=null;g=d.on("immediate-click",function(a){a.stopPropagation();f.location=a.mapPoint;f.visible=!0;c&&c.abort();var e=b.viewModel.editableItems;
c=l.createAbortController();l.create(function(b,q){l.onAbort(c.signal,function(){return q(l.createAbortError())});b(n.fetchCandidates(e,d,a))}).then(function(a){b.viewModel.spinnerViewModel.visible=!1;l.throwIfAborted(c);b.candidates=a.reduce(function(b,a){return a.error?b:b.concat(a.value)},[]);0!==b.candidates.length&&(1===b.candidates.length?(b.edits.feature=b.candidates[0],b.viewModel.activeWorkflow.go("editing-existing-feature")):b.viewModel.activeWorkflow.next())})});k.add(g,this.id);return[2]})})},
tearDown:function(){return c(this,void 0,void 0,function(){return e(this,function(b){k.remove(this.id);return[2]})})}}},"awaiting-update-feature-candidate":function(){return{id:"awaiting-update-feature-candidate",setUp:function(){return c(this,void 0,void 0,function(){var c;return e(this,function(e){c=b.edits;c.feature=null;k.add(z.watch(c,"feature",function(b){a.unhighlight();a.highlight(b)}),this.id);return[2]})})},tearDown:function(){return c(this,void 0,void 0,function(){return e(this,function(b){a.unhighlight();
k.remove(this.id);return[2]})})}}},"editing-existing-feature":function(){return{id:"editing-existing-feature",setUp:function(){return c(this,void 0,void 0,function(){var d,f,g,h=this;return e(this,function(q){d=b.edits.feature;f=b.viewModel;b.editableItem=f.editableItems.find(function(b){return b.layer===d.layer});g=l.createAbortController();k.add({remove:function(){return g.abort()}},this.id);return[2,n.fetchFullFeature(d,f.view,g).then(function(d){return c(h,void 0,void 0,function(){var c,q,h,r,
p,m,t,u,v;return e(this,function(e){switch(e.label){case 0:if(l.isAborted(g))return[2];b.edits.updateGeometry(d.geometry);b.edits.updateAttributes(d.attributes);b.edits.trackChanges();c=d.layer;h=(q=n.findLayerInfo(f.layerInfos,c))&&q.fieldConfig;f.attachmentsViewModel.set({graphic:d,mode:"view"});f.featureFormViewModel.set({feature:d,fieldConfig:h});r=[f.featureFormViewModel.on("value-change",function(){b.edits.updateAttributes(f.featureFormViewModel.getValues());d.attributes=b.edits.feature.attributes}),
f.attachmentsViewModel.watch("mode",function(a){"add"===a&&b.viewModel.activeWorkflow.go("adding-attachment");"edit"===a&&b.viewModel.activeWorkflow.go("editing-attachment")})];p=c.capabilities.editing.supportsGeometryUpdate;if(!p)return[3,2];m=n.getVisualVariableAttributes(d);return[4,n.setUpGeometryUpdate(d,m,f.sketchViewModel,f.view,function(a){var d=a.geometry;a=a.attributes;if(m.rotation){var c=m.rotation.field;f.featureFormViewModel.setValue(c,a[c])}m.size&&(c=m.size.field,f.featureFormViewModel.setValue(c,
a[c]));b.edits.updateAttributes(a);b.edits.updateGeometry(d)})];case 1:return t=e.sent(),u=t.interactive,v=t.visual,r.push(u,v),k.add(u,a._handleKeys.beforeCommit),k.add(v,a._handleKeys.afterCommit),[3,3];case 2:a.highlight(d),e.label=3;case 3:return k.add(r,this.id),[2]}})})})]})})},tearDown:function(){return c(this,void 0,void 0,function(){return e(this,function(c){b.editableItem=null;b.viewModel.featureFormViewModel.set({feature:null,fieldConfig:null});k.remove(this.id);a.unhighlight();return[2]})})}}},
"adding-attachment":function(){return{id:"adding-attachment",parent:"editing-existing-feature",setUp:function(){return c(this,void 0,void 0,function(){return e(this,function(a){return[2]})})},tearDown:function(){return c(this,void 0,void 0,function(){return e(this,function(a){return[2]})})}}},"editing-attachment":function(){return{id:"editing-attachment",parent:"editing-existing-feature",setUp:function(){return c(this,void 0,void 0,function(){return e(this,function(a){return[2]})})},tearDown:function(){return c(this,
void 0,void 0,function(){return e(this,function(a){return[2]})})}}}},g=!1;return["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"].filter(function(a){return g?!0:g=a===d}).map(function(a){return h[a]()})};var h;return d=h=w([g.subclass("esri.widgets.Editor.UpdateWorkflow")],d)}(g.declared(D))});