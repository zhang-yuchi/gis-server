// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/awaiterHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/assignHelper ../../Graphic ../../core/Collection ../../core/Error ../../core/HandleOwner ../../core/watchUtils ../../core/accessorSupport/decorators ../../layers/support/AttachmentInfo ../../tasks/support/AttachmentQuery ../Feature/support/featureUtils".split(" "),function(F,G,y,g,m,p,r,z,A,h,B,C,d,D,u,E){var v=
{editing:!1,operations:{add:!0,update:!0,delete:!0}},w=A.ofType(D);return function(x){function a(c){var b=x.call(this,c)||this;b._getAttachmentsPromise=null;b._attachmentLayer=null;b.abilities=r({},v);b.activeAttachmentInfo=null;b.attachmentInfos=new w;b.graphic=null;b.mode="view";b.handles.add([C.init(b,"graphic",function(){return b._graphicChanged()})]);return b}y(a,x);a.prototype.destroy=function(){this.graphic=this._attachmentLayer=null};a.prototype.castAbilities=function(c){return r({},v,c)};
Object.defineProperty(a.prototype,"state",{get:function(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"supportsResizeAttachments",{get:function(){return this.get("graphic.layer.capabilities.operations.supportsResizeAttachments")||!1},enumerable:!0,configurable:!0});a.prototype.getAttachments=function(){return m(this,void 0,void 0,function(){var c,b,a,e,n,k,q,f;return p(this,function(l){switch(l.label){case 0:c=
this;b=c._attachmentLayer;a=c.attachmentInfos;if(!b||"function"!==typeof b.queryAttachments)throw new h("invalid-layer","getAttachments(): A valid layer is required.");e=this._getFeatureId();n=new u({objectIds:[e],returnMetadata:!0});k=[];this._getAttachmentsPromise=q=b.queryAttachments(n).then(function(b){return b[e]||k}).catch(function(){return k});this.notifyChange("state");return[4,q];case 1:return f=l.sent(),a.removeAll(),f.length&&a.addMany(f),this._getAttachmentsPromise=null,this.notifyChange("state"),
[2,f]}})})};a.prototype.addAttachment=function(c){return m(this,void 0,void 0,function(){var b,a,e,n,k,q,f,d=this;return p(this,function(l){switch(l.label){case 0:b=this;a=b._attachmentLayer;e=b.attachmentInfos;n=b.graphic;k=b.abilities;if(!c)throw new h("invalid-attachment","addAttachment(): An attachment is required.",{attachment:c});if(!k.operations.add)throw new h("invalid-abilities","addAttachment(): add abilities are required.");if(!a||"function"!==typeof a.addAttachment)throw new h("invalid-layer",
"addAttachment(): A valid layer is required.");q=a.addAttachment(n,c).then(function(b){return d._queryAttachment(b.objectId)});return[4,q];case 1:return f=l.sent(),e.add(f),[2,f]}})})};a.prototype.deleteAttachment=function(c){return m(this,void 0,void 0,function(){var b,a,e,n,k,d,f;return p(this,function(l){switch(l.label){case 0:b=this;a=b._attachmentLayer;e=b.attachmentInfos;n=b.graphic;k=b.abilities;if(!c)throw new h("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",
{attachmentInfo:c});if(!k.operations.delete)throw new h("invalid-abilities","deleteAttachment(): delete abilities are required.");if(!a||"function"!==typeof a.deleteAttachments)throw new h("invalid-layer","deleteAttachment(): A valid layer is required.");d=a.deleteAttachments(n,[c.id]).then(function(){return c});return[4,d];case 1:return f=l.sent(),e.remove(f),[2,f]}})})};a.prototype.updateAttachment=function(a,b){void 0===b&&(b=this.activeAttachmentInfo);return m(this,void 0,void 0,function(){var c,
e,d,k,g,f,m,t,r=this;return p(this,function(l){switch(l.label){case 0:c=this;e=c._attachmentLayer;d=c.attachmentInfos;k=c.graphic;g=c.abilities;if(!a)throw new h("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:a});if(!b)throw new h("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:b});if(!g.operations.update)throw new h("invalid-abilities","updateAttachment(): Update abilities are required.");f=d.findIndex(function(a){return a===
b});if(!e||"function"!==typeof e.updateAttachment)throw new h("invalid-layer","updateAttachment(): A valid layer is required.");m=e.updateAttachment(k,b.id,a).then(function(b){return r._queryAttachment(b.objectId)});return[4,m];case 1:return t=l.sent(),d.splice(f,1,t),[2,t]}})})};a.prototype._queryAttachment=function(a){return m(this,void 0,void 0,function(){var b,c,d;return p(this,function(e){if(!a)throw new h("invalid-attachment-id","Could not query attachment.");b=this._attachmentLayer;c=this._getFeatureId();
d=new u({objectIds:[c],attachmentsWhere:"AttachmentId\x3d"+a,returnMetadata:!0});return[2,b.queryAttachments(d).then(function(b){return b[c][0]})]})})};a.prototype._getFeatureId=function(){var a=this._attachmentLayer,b=this.graphic;if(!a||!b)return null;a=a.objectIdField;return(b=b.attributes)&&b[a]};a.prototype._graphicChanged=function(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch(function(){}))};a.prototype._setAttachmentLayer=function(){var a=E.getSourceLayer(this.graphic);
this._attachmentLayer=a?"scene"===a.type&&a.associatedLayer?a.associatedLayer:a:null};g([d.property()],a.prototype,"abilities",void 0);g([d.cast("abilities")],a.prototype,"castAbilities",null);g([d.property()],a.prototype,"activeAttachmentInfo",void 0);g([d.property({readOnly:!0,type:w})],a.prototype,"attachmentInfos",void 0);g([d.property({type:z})],a.prototype,"graphic",void 0);g([d.property()],a.prototype,"mode",void 0);g([d.property({dependsOn:["graphic"],readOnly:!0})],a.prototype,"state",null);
g([d.property({readOnly:!0,dependsOn:["graphic","graphic.layer","graphic.layer.loaded","graphic.layer.capabilities.operations.supportsResizeAttachments"]})],a.prototype,"supportsResizeAttachments",null);return a=g([d.subclass("esri.widgets.Attachments.AttachmentsViewModel")],a)}(d.declared(B.HandleOwner))});