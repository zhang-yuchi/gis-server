// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../request ../../../../core/arrayUtils ../../../../core/Error ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/typedArrayUtil ../../../../core/wgs84Constants ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/quat ../../../../core/libs/gl-matrix-2/quatf32 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/SpatialReference ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/webMercatorUtils ../../../../tasks/support/Query ./I3SBinaryReader ../support/edgeUtils ../support/symbolColorUtils ../../support/projectionUtils".split(" "),
function(ja,e,P,Q,n,u,t,A,B,R,v,S,h,T,U,C,V,W,X,Y,D,Z,q){function z(a){return a&&parseInt(a.substring(a.lastIndexOf("/")+1,a.length),10)}function E(a,b){var c=b[0],f=b[1],d=b[2];b=b[3];var k=a[0]-c,c=c-a[3],e=a[1]-f,f=f-a[4],F=a[2]-d;a=d-a[5];var d=Math.max(k,c,0),g=Math.max(e,f,0),h=Math.max(F,a,0),d=d*d+g*g+h*h;return d>b*b?0:0<d?1:-Math.max(k,c,e,f,F,a)>b?3:2}function H(a,b,c){var f=[],d=c&&c.missingFields;c=c&&c.originalFields;for(var k=0;k<a.length;k++){for(var e=a[k],g=e.toLowerCase(),G=!1,
h=0,l=b;h<l.length;h++){var I=l[h];if(g===I.name.toLowerCase()){f.push(I.name);G=!0;c&&c.push(e);break}}!G&&d&&d.push(e)}return f}function aa(a,b){return a.filter(function(a){return a!==b}).concat([b])}function ba(a,b,c,f){b.sort(function(a,b){return a.attributes[c]-b.attributes[c]});var d=b.map(function(a){return a.attributes[c]}),k=[],e=H(f,a.fields,{originalFields:k});return J(a,d,e).then(function(a){for(var c=0;c<b.length;c++){var d=b[c],f=a[c],g={};if(d.attributes)for(var h in d.attributes)g[h]=
d.attributes[h];for(var w=0;w<k.length;w++)g[k[w]]=f[e[w]];d.attributes=g}return b})}function J(a,b,c){var f=a.capabilities.query.maxRecordCount;if(null!=f&&b.length>f)return f=ca(b,f),t.all(f.map(function(b){return J(a,b,c)})).then(da);f=new X({objectIds:b,outFields:c,orderByFields:[a.objectIdField]});return a.queryFeatures(f).then(function(a){if(a&&a.features&&a.features.length===b.length)return a.features.map(function(a){return a.attributes});throw new n("scenelayer:feature-not-in-associated-layer",
"Feature not found in associated feature layer");})}function ea(a,b,c,f,d){for(var e=[],g=0;g<b.length;g++){var h=b[g];h&&-1!==d.indexOf(h.name)&&e.push({url:a+"/nodes/"+c.resources.attributes+"/attributes/"+h.key+"/0",storageInfo:h})}return t.eachAlways(e.map(function(a){return P(a.url,{responseType:"array-buffer"}).then(function(b){return Y.readBinaryAttribute(a.storageInfo,b.data)})})).then(function(a){for(var b=[],c=0;c<f.length;c++){for(var d=f[c],g={},k=0;k<a.length;k++)null!=a[k].value&&(g[e[k].storageInfo.name]=
K(a[k].value,d));b.push(g)}return b})}function K(a,b){if(!a)return null;b=a[b];return A.isInt16Array(a)?b===fa?null:b:A.isInt32Array(a)?b===ga?null:b:b!==b?null:b}function ca(a,b){var c=a.length;b=Math.ceil(c/b);for(var f=[],d=0;d<b;d++)f.push(a.slice(Math.floor(c*d/b),Math.floor(c*(d+1)/b)));return f}function da(a){for(var b=[],c=0;c<a.length;c++)b=b.concat(a[c]);return b}function L(a){var b=new C(z(a.store.indexCRS||a.store.geographicCRS));return b.equals(a.spatialReference)?a.spatialReference:
b}function M(a){var b=new C(z(a.store.vertexCRS||a.store.projectedCRS));return b.equals(a.spatialReference)?a.spatialReference:b}function x(a,b,c){if(!W.canProject(a,b))throw new n("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===c&&a.isGeographic)throw new n("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{});}function N(a,b,c){var f=
L(a);a=M(a);x(f,b,c);x(a,b,c)}Object.defineProperty(e,"__esModule",{value:!0});e.DDS_ENCODING_STRING="image/vnd-ms.dds";e.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"];e.extractWkid=z;e.selectEncoding=function(a,b){if(b)for(b=0;b<a.length;b++)if(a[b].encoding===e.DDS_ENCODING_STRING)return a[b];for(b=0;b<a.length;b++)if(-1<e.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(a[b].encoding))return a[b];return null};e.findIntersectingNodes=function(a,b,c,f,d,e){d.traverse(c,function(c){var d=
c.mbs;b!==f&&(d=ha,q.mbsToMbs(c.mbs,f,d,b));d=E(a,d);if(0!==d)return e(c,d),!0})};e.filterInPlace=function(a,b,c){for(var f=0,d=0,e=0;e<b.length&&f<a.length;e++)a[f]===b[e]&&(c(e)&&(a[d]=a[f],d++),f++);a.length=d};var r=V.create();e.getClipAABB=function(a,b){if(0===b.rotationScale[1]&&0===b.rotationScale[2]&&0===b.rotationScale[3]&&0===b.rotationScale[5]&&0===b.rotationScale[6]&&0===b.rotationScale[7])return r[0]=(a[0]-b.position[0])/b.rotationScale[0],r[1]=(a[1]-b.position[1])/b.rotationScale[4],
r[2]=(a[2]-b.position[2])/b.rotationScale[8],r[3]=(a[3]-b.position[0])/b.rotationScale[0],r[4]=(a[4]-b.position[1])/b.rotationScale[4],r[5]=(a[5]-b.position[2])/b.rotationScale[8],r};var ha=U.vec4f64.create();e.intersectBoundingBoxWithMbs=E;e.findFieldsCaseInsensitive=H;e.whenGraphicAttributes=function(a,b,c,f,d,e){!0===(e&&e.populateObjectId)&&(f=aa(f,c));if(0===b.length)return t.resolve(b);e=a.associatedLayer;var g=a.attributeStorageInfo;if(e)return ba(e,b,c,f);if(g){b=d(b);if(!b)return t.reject(new n("scenelayer:features-not-loaded",
"Tried to query attributes for unloaded features"));var h=a.parsedUrl.path;return t.all(b.map(function(a){return ea(h,g,a.node,a.indices,f).then(function(b){for(var c=0;c<a.graphics.length;c++){var d=a.graphics[c],f=b[c];if(d.attributes)for(var e in d.attributes)e in f||(f[e]=d.attributes[e]);d.attributes=f}return a.graphics})})).then(Q.flatten)}return t.reject(new n("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))};var fa=-Math.pow(2,15),ga=-Math.pow(2,
31);e.getCachedAttributeValue=K;e.convertFlatRangesToOffsets=function(a,b,c){b=null!=b?b:a.length/c;for(var f=new Uint32Array(b+1),d=0;d<b;d++){var e=a[d*c];f[d]=3*e;var g=(d-1)*c+1;if(0<=g&&e-1!==a[g])throw new n("Face ranges are not continuous");}f[f.length-1]=3*(a[(b-1)*c+1]+1);return f};e.getIndexCrs=L;e.getVertexCrs=M;e.getCacheKeySuffix=function(a,b){return b===q.SphericalECEFSpatialReference?"@ECEF":a.equals(b)?"":null!=b.wkid?"@"+b.wkid:null};e.checkSpatialReference=x;e.checkSpatialReferences=
N;e.checkSceneLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(b=a.store.defaultGeometrySchema,b=!!(null!=b.geometryType&&"triangles"!==b.geometryType||null!=b.topology&&"PerAttributeArray"!==b.topology||null==b.vertexAttributes||null==b.vertexAttributes.position));if(b)throw new n("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:a.parsedUrl.path});};e.checkSceneLayerCompatibleWithView=function(a,b){N(a,
b.spatialReference,b.viewingMode)};e.checkPointCloudLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(a=a.store.defaultGeometrySchema,b=!!(null==a.geometryType||"points"!==a.geometryType||null!=a.topology&&"PerAttributeArray"!==a.topology||null!=a.encoding&&""!==a.encoding&&"lepcc-xyz"!==a.encoding||null==a.vertexAttributes||null==a.vertexAttributes.position));if(b)throw new n("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",
{});};e.checkPointCloudLayerCompatibleWithView=function(a,b){x(a.spatialReference,b.spatialReference,b.viewingMode)};e.rendererNeedsTextures=function(a){if(null==a||"simple"!==a.type&&"class-breaks"!==a.type&&"unique-value"!==a.type||("unique-value"===a.type||"class-breaks"===a.type)&&null==a.defaultSymbol)return!0;a=a.getSymbols();if(0===a.length)return!0;for(var b=0;b<a.length;b++){var c=a[b];if("mesh-3d"!==c.type||0===c.symbolLayers.length)return!0;for(var f=0,c=c.symbolLayers.items;f<c.length;f++){var d=
c[f];if("fill"!==d.type||u.isNone(d.material)||u.isNone(d.material.color)||"replace"!==d.material.colorMixMode)return!0}}return!1};e.transparentEdgeMaterial=D.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0});var O=function(){return function(){this.material=this.edgeMaterial=null;this.castShadows=!0}}();e.SymbolInfo=O;e.getSymbolInfo=function(a){var b=new O,c=!1,f=!1,d=0;for(a=a.symbolLayers.items;d<a.length;d++){var e=a[d];if("fill"===e.type&&e.enabled){var g=e.material,h=e.edges;u.isSome(g)&&
!c&&(c=g.color,g=Z.parseColorMixMode(g.colorMixMode),u.isSome(c)?b.material={color:[c.r/255,c.g/255,c.b/255],alpha:c.a,colorMixMode:g}:b.material={color:[1,1,1],alpha:1,colorMixMode:1},b.castShadows=e.castShadows,c=!0);u.isSome(h)&&!f&&(b.edgeMaterial=D.createMaterialFromEdges(h,{}),f=!0)}}b.material||(b.material={color:[1,1,1],alpha:1,colorMixMode:1});return b};e.addWraparound=function(a,b){return(a|0)+(b|0)|0};e.transformObb=function(a,b,c,e,d,k){void 0===d&&(d=0);void 0===k&&(k=!1);if(e!==y||k)h.vec3.set(c.center,
a.center[0],a.center[1],a.center[2]+d),q.bufferToBuffer(c.center,b,0,c.center,e,0,1),v.quat.copy(c.quaternion,a.quaternion),h.vec3.copy(c.halfSize,a.halfSize);else if(b.isGeographic)e=1+Math.max(0,d)/(B.wgs84Radius+a.center[2]),h.vec3.set(c.center,a.center[0],a.center[1],a.center[2]+d),q.bufferToBuffer(c.center,b,0,c.center,y,0,1),v.quat.copy(c.quaternion,a.quaternion),v.quat.conjugate(m,a.quaternion),h.vec3.set(g,0,0,1),h.vec3.transformQuat(g,g,m),h.vec3.set(g,a.halfSize[0]*Math.abs(g[0]),a.halfSize[1]*
Math.abs(g[1]),a.halfSize[2]*Math.abs(g[2])),h.vec3.scale(g,g,ia),h.vec3.add(c.halfSize,a.halfSize,g),h.vec3.scale(c.halfSize,c.halfSize,e);else{h.vec3.set(c.center,a.center[0],a.center[1],a.center[2]+d);for(d=0;8>d;d++)h.vec3.set(g,a.halfSize[0]*(1===(d&1)?-1:1),a.halfSize[1]*(2===(d&2)?-1:1),a.halfSize[2]*(4===(d&4)?-1:1)),h.vec3.transformQuat(g,g,a.quaternion),h.vec3.add(g,g,c.center),p[3*d+0]=g[0],p[3*d+1]=g[1],p[3*d+2]=g[2];q.computeLinearTransformation(b,c.center,l,y);d=2*Math.sqrt(1+l[0]+l[5]+
l[10]);m[0]=(l[6]-l[9])/d;m[1]=(l[8]-l[2])/d;m[2]=(l[1]-l[4])/d;m[3]=.25*d;v.quat.multiply(c.quaternion,m,a.quaternion);h.vec3.set(c.center,l[12],l[13],l[14]);q.bufferToBuffer(p,b,0,p,y,0,8);v.quat.conjugate(m,c.quaternion);for(d=e=b=a=0;8>d;d++)h.vec3.set(g,p[3*d+0],p[3*d+1],p[3*d+2]),h.vec3.sub(g,g,c.center),h.vec3.transformQuat(g,g,m),a=Math.max(a,Math.abs(g[0])),b=Math.max(b,Math.abs(g[1])),e=Math.max(e,Math.abs(g[2]));h.vec3.set(c.halfSize,a,b,e)}};var y=q.SphericalECEFSpatialReference,ia=1/
(1-B.wgs84Flattening)-1,g=T.vec3f64.create(),l=R.mat4f64.create(),m=S.quatf32.create(),p=new Float64Array(24)});