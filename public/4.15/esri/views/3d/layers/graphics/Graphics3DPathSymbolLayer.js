// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Error ../../../../core/lang ../../../../core/mathUtils ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat2 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f32 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../layers/graphics/dehydratedFeatures ./elevationAlignmentUtils ./elevationAlignmentUtils ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ../support/FastSymbolUpdates ../../support/projectionUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/pathGeometryUtils ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/PathMaterial".split(" "),
function(A,g,W,ka,X,Y,Z,aa,z,D,ba,F,ca,d,I,J,G,B,K,L,da,H,M,N,O,ea,fa,c,ga,ha){function P(h,a,k){switch(a){case "world":for(var b=0,r=h.vertices;b<r.length;b++)a=r[b],d.vec3.add(m,a.pos,h.offset),k.worldUpAtPosition(m,t),a.setFrameFromUpVector(t),a.computeRotationAxisAndAngleFromUpVector();break;case "path":for(d.vec3.add(m,h.vertices[0].pos,h.offset),k.worldUpAtPosition(m,t),c.computeMinimumRotationTangentFrame(h,t),k=0,h=h.vertices;k<h.length;k++){a=h[k];b=z.sign(d.vec3.dot(a.frame.right,a.vRight));
d.vec3.cross(a.rotationFrame.up,a.vRight,a.vLeft);d.vec3.scale(a.rotationFrame.up,a.rotationFrame.up,b);d.vec3.normalize(a.rotationFrame.up,a.rotationFrame.up);var r=d.vec3.dot(a.rotationFrame.up,a.frame.up),w=d.vec3.dot(a.rotationFrame.up,a.frame.right);d.vec3.scale(m,a.frame.up,-w);d.vec3.scale(Q,a.frame.right,r);d.vec3.add(m,m,Q);d.vec3.normalize(a.rotationFrame.right,m);c.vertexSpaceToProfileSpace(a.rotationRight,a.frame,a.rotationFrame.right);d.vec3.negate(m,a.vLeft);a.rotationAngle=-b*(Math.PI-
z.acosClamped(d.vec3.dot(m,a.vRight)));0<Math.abs(a.rotationAngle)&&(b=z.reciprocalClamped(Math.cos(.5*a.rotationAngle)),ba.mat2.set(a.miterStretch,1+(b-1)*a.rotationRight[0]*a.rotationRight[0],(b-1)*a.rotationRight[0]*a.rotationRight[1],(b-1)*a.rotationRight[0]*a.rotationRight[1],1+(b-1)*a.rotationRight[1]*a.rotationRight[1]));a.maxStretchDistance=Math.abs(Math.min(a.vLeftLength,a.vRightLength)*z.reciprocalClamped(Math.cos(.5*(Math.PI-a.rotationAngle))))}}}function R(c,a,k){switch(c){case "symbol-value":return k;
case "proportional":return a;default:return c}}function ia(c,a,k,b){c=c.stageObject;var r=c.geometryRecords,w=r.length,S=0;x.spatialReference=k.spatialReference;ja.spatialReference=b.spatialReference;for(var e=0;e<w;e++){var E=r[e].geometry,n=E.metadata,T=n.pathGeometry,y=T.builder.path;U.spatialReference=n.geometrySR;for(var p=y,v=a,h=k,f=b,l=0,q=0,u=p.vertices;q<u.length;q++){var g=u[q];x.x=g.posES[0];x.y=g.posES[1];x.z=g.posES[2];var m=K.evaluateElevationAlignmentAtPoint(x,h,v,f,V),l=l+V.sampledElevation;
d.vec3.add(t,g.pos,p.offset);f.setAltitude(m,t);d.vec3.subtract(g.pos,t,p.offset)}p.updatePathVertexInformation();S+=l/p.vertices.length;"world"!==y.upVector&&P(y,n.upVectorAlignment,b);T.onPathChanged();E.invalidateBoundingInfo();c.geometryVertexAttrsUpdated(e)}return S/w}Object.defineProperty(g,"__esModule",{value:!0});A=function(h){function a(a,b,r,c){a=h.call(this,a,b,r,c)||this;a._intrinsicSize=ca.vec2f64.fromValues(1,1);a.upVectorAlignment="path";a.stencilWidth=.1;a.ensureDrapedStatus(!1);return a}
W(a,h);a.prototype.doLoad=function(){return Y(this,void 0,void 0,function(){var a,b,r,w,d,e,E,n,h,y,p,v,m,f;return X(this,function(k){a=D.isSome(this.symbolLayer.width)?this.symbolLayer.width:D.isSome(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size;b=D.isSome(this.symbolLayer.height)?this.symbolLayer.height:a;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[a,1,b],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,
0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}};this._fastUpdates=this._context.renderer&&this._context.renderer.visualVariables&&0<this._context.renderer.visualVariables.length?N.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):{enabled:!1};r=this.symbolLayer.anchor||"center";this.upVectorAlignment="path";"heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");w=this.symbolLayer.profile||"circle";switch(w){default:this._profile=c.Profile.circle(g.NUM_CIRCLE_PROFILE_SUBDIVISIONS);
break;case "quad":this._profile=c.Profile.rect()}d=[0,0];"center"!==r&&(d={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[r],this._profile.translate(d[0],d[1]));e=this.symbolLayer.join||"simple";switch(e){case "round":this._extruder=new c.MiterExtruder(0,g.NUM_ROUND_JOIN_SUBDIVISIONS);break;case "bevel":this._extruder=new c.MiterExtruder(0,1);break;case "miter":this._extruder=new c.MiterExtruder(.8*Math.PI,1);break;default:this._extruder=new c.SimpleExtruder}E=this.symbolLayer.cap||"butt";switch(E){case "none":this._startCap=
new c.NoCapBuilder;this._endCap=new c.NoCapBuilder;break;default:this._startCap=new c.TriangulationCapBuilder(this._profile,0);this._endCap=new c.TriangulationCapBuilder(this._profile,0,!0);break;case "square":this._startCap=new c.TriangulationCapBuilder(this._profile,-.5);this._endCap=new c.TriangulationCapBuilder(this._profile,.5,!0);break;case "round":n="quad"===w?!0:!1,this._startCap=new c.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:n,subdivisions:g.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS}),
this._endCap=new c.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:n,subdivisions:g.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS})}h=this._getIdHint();y=D.get(this.symbolLayer,"material","color");p=this._getCombinedOpacityAndColor(y);v=J.vec3f64.fromArray(p);m=p[3];f={diffuse:v,ambient:v,opacity:m,transparent:1>m||this.needsDrivenTransparentPass,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:"none"===E?0:void 0,offsetTransparentBackfaces:!0};
if(!this._drivenProperties.size&&(F.vec2.set(this._intrinsicSize,a,b),!M.isValidSize(this._intrinsicSize[0])||!M.isValidSize(this._intrinsicSize[1])))throw new Z("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||F.vec2.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters);this._fastUpdates.enabled?(aa.mixin(f,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],
this._intrinsicSize[1],0]}),this._material=new ha(f,h+"_pathmat")):(f.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new ga(f,h+"_pathmat"));this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});this._context.stage.add(3,this._material);return[2]})})};a.prototype.destroy=function(){h.prototype.destroy.call(this);this._material&&(this._context.stage.remove(3,this._material.id),this._material=null)};a.prototype.createGraphics3DGraphic=
function(k){var b=k.graphic;if(!this._validateGeometryType(b.geometry,a.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(b.geometry))return null;var c="graphic"+b.uid,d=this.getGraphicElevationContext(b);return this._createAs3DShape(b,k.renderingInfo,d,c,b.uid)};a.prototype.layerOpacityChanged=function(){var a=D.get(this.symbolLayer,"material","color"),a=this._getCombinedOpacity(a);this._material.setParameterValues({opacity:a,transparent:1>a||this.needsDrivenTransparentPass});return!0};
a.prototype.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,L.needsElevationUpdates3D)};a.prototype.slicePlaneEnabledChanged=function(){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};a.prototype.physicalBasedRenderingChanged=function(){this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});return!0};a.prototype.pixelRatioChanged=function(){return!0};a.prototype.applyRendererDiff=
function(a,b){for(var c in a.diff)switch(c){case "visualVariables":if(N.updateFastSymbolUpdatesState(this._fastUpdates,b,this._vvConvertOptions))this._material.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};a.prototype.getVertexData=function(a){for(var b=0,c=a.paths,d=[],k=a.spatialReference,e=this._context.elevationProvider.spatialReference,h=this._context.renderCoordsHelper.spatialReference,n=0;n<c.length;n++)var g=c[n],b=b+g.length;for(var n=
new Float64Array(3*b),m=new Float64Array(3*b),p=new Float64Array(3*b),v=0,t=0;t<c.length;t++){g=c[t];d.push({index:v,numVertices:g.length});for(var f=0;f<g.length;f++){var l=g[f];n[v++]=l[0];n[v++]=l[1];n[v++]=a.hasZ?l[2]:0}}a=!0;k.equals(e)?this._copyVertices(n,0,m,0,b):a=O.bufferToBuffer(n,k,0,m,e,0,b);e.equals(h)?this._copyVertices(m,0,p,0,b):O.bufferToBuffer(m,e,0,p,h,0,b);return{pathVertexDataInfos:d,vertexDataGS:n,vertexDataES:m,vertexDataRS:p,projectionSuccess:a,terrainElevation:0}};a.prototype._copyVertices=
function(a,b,c,d,g){b*=3;d*=3;for(var e=0;e<g;++e)c[d++]=a[b++],c[d++]=a[b++],c[d++]=a[b++]};a.prototype._createAs3DShape=function(a,b,g,h,m){var e=a.geometry,k=[],n=[],r=[],y=e.spatialReference,p=this._context.elevationProvider.spatialReference,v=G.create(),w=this._context.renderCoordsHelper;U.spatialReference=y;x.spatialReference=p;e=this.getVertexData(e);if(!e.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),
null;if(0<e.pathVertexDataInfos.length){for(p=0;p<e.pathVertexDataInfos.length;++p){var f=e.pathVertexDataInfos[p],l=f.index,f=f.numVertices;if(2>f)this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");else{if(D.isSome(this._context.clippingExtent)&&(G.empty(v),G.expandWithBuffer(v,e.vertexDataES,3*l,f),!G.intersectsClippingArea(v,this._context.clippingExtent)))continue;for(var q=[],u=l;u<l+3*f;){var z=u++,A=u++,B=u++,C=new c.PathVertex;d.vec3.set(C.posGS,
e.vertexDataGS[z],e.vertexDataGS[A],e.vertexDataGS[B]);d.vec3.set(C.posES,e.vertexDataES[z],e.vertexDataES[A],e.vertexDataES[B]);x.x=C.posES[0];x.y=C.posES[1];x.z=C.posES[2];var F=K.evaluateElevationAlignmentAtPoint(x,this._context.elevationProvider,g,w,null);d.vec3.set(t,e.vertexDataRS[z],e.vertexDataRS[A],e.vertexDataRS[B]);w.setAltitude(F,t);d.vec3.set(C.pos,t[0],t[1],t[2]);q.push(C)}l=new c.Path(q);P(l,this.upVectorAlignment,this._context.renderCoordsHelper);l=new c.Builder(l,this._profile,this._extruder,
this._startCap,this._endCap);f=null;this._fastUpdates.enabled?(u=this._fastUpdates.visualVariables,f=u.size?H.getAttributeValue(u.size.field,a):0,q=u.color?H.getAttributeValue(u.color.field,a):0,u=u.opacity?H.getAttributeValue(u.opacity.field,a):0,f=new c.FastUpdatePathGeometry(l,f,q,u)):(f=[this._intrinsicSize[0],this._intrinsicSize[1]],this._drivenProperties.size&&(f[0]*=R(b.size[0],"symbol-value"===b.size[2]?this.symbolLayer.height||0:b.size[2],this.symbolLayer.width||0),f[1]*=R(b.size[2],"symbol-value"===
b.size[0]?this.symbolLayer.width||0:b.size[0],this.symbolLayer.height||0)),q=null,this._drivenProperties.color&&(q=b.color),this._drivenProperties.opacity&&null!=b.opacity&&(q=q?[q[0],q[1],q[2],b.opacity]:[1,1,1,b.opacity]),l=new c.StaticPathGeometry(l),l.bake(f),q&&l.bakeVertexColors(q),f=l);l=f.createGeometryData();l=new ea(l,h+"path"+p);l.metadata={pathGeometry:f,geometrySR:y,upVectorAlignment:this.upVectorAlignment,stencilWidth:this.stencilWidth};k.push(l);n.push(this._material);r.push(f.xform)}}a=
{layerUid:this._context.layer.uid,graphicUid:m};if(0<k.length)return h=new fa({geometries:k,materials:n,transformations:r,castShadow:!0,metadata:a,idHint:h}),k=new da(this,h,k,null,null,ia,g),k.alignedSampledElevation=e.terrainElevation,k.needsElevationUpdates=L.needsElevationUpdates3D(g.mode),k}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null};a.validGeometryTypes=["polyline"];return a}(H.Graphics3DSymbolLayer);g.Graphics3DPathSymbolLayer=
A;var ja=B.makeDehydratedPoint(0,0,0,null),x=B.makeDehydratedPoint(0,0,0,null),U=B.makeDehydratedPoint(0,0,0,null),t=J.vec3f64.create(),m=I.vec3f32.create(),Q=I.vec3f32.create();g.NUM_ROUND_JOIN_SUBDIVISIONS=3;g.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=3;g.NUM_CIRCLE_PROFILE_SUBDIVISIONS=10;var V={verticalDistanceToGround:0,sampledElevation:0};g.default=A});