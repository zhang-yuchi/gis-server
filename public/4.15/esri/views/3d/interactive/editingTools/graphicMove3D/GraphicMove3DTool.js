// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/Collection ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/accessorSupport/decorators ../../../../../layers/graphics/dehydratedFeatures ../../../../../support/elevationInfoUtils ../../manipulatorUtils ../manipulatorDragUtils ../manipulatorUtils ../settings ../visualElementUtils ./isSupportedGraphic ../manipulations/config ../manipulations/MoveManipulation ../manipulations/moveUtils ../manipulations/MoveXYGraphicManipulation ../../visualElements/OutlineVisualElement ../../../layers/graphics/GraphicState ../../../../interactive/InteractiveToolBase".split(" "),
function(q,k,l,B,r,C,D,t,E,u,h,F,G,H,v,I,w,J,K,L,x,M,N,y,O,P){Object.defineProperty(k,"__esModule",{value:!0});var z=function(){return function(f){this.allGraphics=f;this.type="graphic-move-start"}}();k.GraphicMoveStartEvent=z;var A=function(){return function(f,b,a,c){this.dx=f;this.dy=b;this.dz=a;this.allGraphics=c;this.type="graphic-move"}}();k.GraphicMoveEvent=A;var p=function(){return function(f){this.allGraphics=f;this.type="graphic-move-stop"}}();k.GraphicMoveStopEvent=p;q=function(f){function b(a){a=
f.call(this,a)||this;a.graphics=new C;a.enableZ=!0;a.type="move-3d";a._toolHandles=new t;a._handles=new t;return a}B(b,f);b.prototype.initialize=function(){var a=this;this._toolHandles.add([this.graphics.on("change",function(){a._refreshManipulators()}),w.settings.zManipulator.watch(w.settings.zManipulator.keys(),function(){return a._refreshManipulators()})]);this._refreshManipulators()};b.prototype.destroy=function(){this._handles.destroy();this._handles=null;this._toolHandles.destroy();this._toolHandles=
null;this.graphics.removeAll();this._set("view",null)};b.prototype.reset=function(){};b.prototype._refreshManipulators=function(){var a=this;this._handles.removeAll();this._moveManipulation&&this._moveManipulation.destroy();this.manipulators.removeAll();var c=this.graphics.toArray().filter(function(a){return 0===K.isSupportedGraphic(a)}).map(function(a){return new Q(a)});c.length&&(this.createManipulators(c),this.createVisualElements(c),this._handles.add(c.map(function(c){return a.view.trackGraphicState(c.state)})),
this.updateMoveManipulation(c))};b.prototype.createManipulators=function(a){for(var c=this,b=function(d){var e=d.state;d.manipulationXY=new N.MoveXYGraphicManipulation({tool:g,view:g.view,graphicState:e});d.manipulationXY.forEachManipulator(function(a){return c._handles.add(a.events.on("immediate-click",function(a){c.emit("immediate-click",r({},a,{graphic:e.graphic}));a.stopPropagation()}))});g._handles.add(d.manipulationXY.createDragPipeline(function(e,d,b){return c.buildDragEventPipeline(e,d,b,
a)}))},g=this,d=0;d<a.length;d++)b(a[d]);this.createMoveManipulation(a)};b.prototype.createMoveManipulation=function(a){var c=this,b=new x.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===a.length?x.MoveManipulation.radiusForSymbol(a[0].graphic.symbol):L.DISC_RADIUS});this._moveManipulation=b;b.elevationInfo={mode:"absolute-height",offset:0};b.forEachManipulator(function(a){c._handles.add(a.events.on("immediate-click",function(e){b.zManipulation.hasManipulator(a)||
1!==c.graphics.length||c.emit("immediate-click",r({},e,{graphic:c.graphics.getItemAt(0)}));e.stopPropagation()}))});for(var g=function(){return c.updateMoveManipulation(a)},d=0;d<a.length;d++){var m=a[d];this._handles.add([m.state.on("changed",g),m.state.watch("displaying",g)])}var e=a[a.length-1];this._handles.add(e.state.on("changed",function(){return c.updateMoveManipulationAngle(e)}));this._handles.add(b.createDragPipeline(function(e,d,b){c.buildDragEventPipeline(e,d,b,a)},G.getGraphicEffectiveElevationInfo(e.graphic),
u.expect(e.graphic.geometry).spatialReference));this.updateMoveManipulationAngle(e)};b.prototype.createVisualElements=function(a){for(var c=this,b=function(d){var e=J.createVisualElements({view:g.view,graphic:d.graphic,forEachManipulator:function(a){d.manipulationXY.forEachManipulator(a);c._moveManipulation.forEachManipulator(a)},onManipulatorsChanged:function(){return E.makeHandle()}});d.geometryRepresentation=e.visualElement;d.geometryRepresentation instanceof y.OutlineVisualElement&&g._handles.add([d.geometryRepresentation.events.on("attachment-origin-changed",
function(){d.state.isDraped||c.updateMoveManipulation(a)}),d.state.watch("isDraped",function(){return c.updateMoveManipulation(a)})]);g._handles.add(e)},g=this,d=0;d<a.length;d++)b(a[d])};b.prototype.updateMoveManipulationAngle=function(a){this._moveManipulation.angleDeferred=function(){return M.primaryShapeOrientation(a.graphic.geometry)}};b.prototype.updateMoveManipulation=function(a){for(var c=F.makeDehydratedPoint(0,0,0,this.view.spatialReference),b=0,g=!1,d=this._moveManipulation,m=0;m<a.length;m++){var e=
a[m];if(e.state.displaying){var f=e.state.graphic;this.enableZ&&I.canMoveZ(f)&&(g=!0);e=e.geometryRepresentation instanceof y.OutlineVisualElement&&!e.state.isDraped?e.geometryRepresentation.attachmentOrigin:H.getGraphicAttachmentOrigin(this.view,f);u.isSome(e)&&(c.x+=e.x,c.y+=e.y,c.z+=e.z,b++)}}0<b?(c.x/=b,c.y/=b,c.z/=b,d.location=c,d.xyManipulation.available=!0,d.xyAxisManipulation.available=!0,d.zManipulation.available=g):d.available=!1};b.prototype.buildDragEventPipeline=function(a,b,f,g){var d=
this,c=[],e=[],h=null,k=null,l=function(){for(var a=0;a<c.length;a++)c[a].dragging=!1;c.length=0;e.length=0;k=h=null;d._moveManipulation.interactive=!0};b.next(function(b){if("start"===b.action){c.length=0;for(var f=e.length=0;f<g.length;f++){var n=g[f];n.dragging||!n.manipulationXY.hasManipulator(a)&&n.manipulationXY.grabbing||(c.push(n),e.push(n.graphic),n.dragging=!0)}if(0!==e.length&&(d._moveManipulation.interactive=!1,h=v.dragGraphicMany(e),k=v.resetGraphicMany(e),d.emit("graphic-move-start",
new z(e)),d.destroyed))return null}return 0!==e.length?b:null}).next(function(a){return h(a)}).next(function(a){switch(a.action){case "start":case "update":if(a.translationX||a.translationY||a.translationZ)if(d.emit("graphic-move",new A(a.translationX,a.translationY,a.translationZ,e)),d.destroyed)return null;break;case "end":d.emit("graphic-move-stop",new p(e));if(d.destroyed)return null;l()}});f.next(function(a){return k(a)}).next(function(){d.emit("graphic-move-stop",new p(e));if(d.destroyed)return null;
l()})};l([h.property({constructOnly:!0,nonNullable:!0})],b.prototype,"view",void 0);l([h.property({readOnly:!0})],b.prototype,"graphics",void 0);l([h.property({constructOnly:!0,nonNullable:!0})],b.prototype,"enableZ",void 0);l([h.property({readOnly:!0})],b.prototype,"type",void 0);return b=l([h.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMove3DTool")],b)}(h.declared(D.EventedMixin(P.InteractiveToolBase)));k.GraphicMove3DTool=q;var Q=function(){function f(b){this.manipulationXY=
this.geometryRepresentation=this.state=null;this.dragging=!1;this.state=new O.GraphicState({graphic:b})}Object.defineProperty(f.prototype,"graphic",{get:function(){return this.state.graphic},enumerable:!0,configurable:!0});return f}()});