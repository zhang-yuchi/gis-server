// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define(["require","exports","../webgl-engine/lib/Util"],function(e,f,g){Object.defineProperty(f,"__esModule",{value:!0});e=function(){return function(b){this.clientType=b;this._cancelled=!1;this.duration=this.size=0}}();f.BaseTask=e;e=function(){function b(a,c,b,h){var d=this;this._workerFunc=a;this._callbackFunc=c;this._maxTotalNumWorkers=b;this._type2id=new Map;this._tasks=[];this._typeNumWorkers=[];this._typeWorkerQuota=[];this._typeStatistics=[];this._totalNumWorkers=0;h.forEach(function(a,c){d._type2id.set(c,
d._tasks.length);d._tasks.push([]);d._typeNumWorkers.push(0);d._typeStatistics.push({requests:0,size:0,duration:0,speed:0});d._typeWorkerQuota.push(a)})}Object.defineProperty(b.prototype,"numTypes",{get:function(){return this._tasks.length},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"busy",{get:function(){return this._totalNumWorkers>=this._maxTotalNumWorkers},enumerable:!0,configurable:!0});b.prototype.push=function(a){var c=this,b=this._type2id.get(a.clientType);this._totalNumWorkers<
this._maxTotalNumWorkers?(this._typeNumWorkers[b]++,this._totalNumWorkers++,this._workerFunc(a,function(a,b){return c._taskCallback(a,b)})):this._tasks[b].push(a)};b.prototype.getStatsForType=function(a){a=this._type2id.get(a);return{quota:this._typeWorkerQuota[a],workers:this._typeNumWorkers[a],queueSize:this._tasks[a].length,requestStats:this._typeStatistics[a]}};b.prototype.cancel=function(a){this._taskFinished(a);a._cancelled=!0};b.prototype.clear=function(){for(var a=0;a<this._tasks.length;a++)this._tasks[a]=
[]};b.prototype._taskFinished=function(a){var c=this._type2id.get(a.clientType);this._typeNumWorkers[c]--;this._totalNumWorkers--;this._typeStatistics[c].requests++;this._typeStatistics[c].size+=a.size||0;this._typeStatistics[c].duration+=a.duration||0;this._typeStatistics[c].speed=0<this._typeStatistics[c].duration?this._typeStatistics[c].size/this._typeStatistics[c].duration:0;g.assert(0<=this._typeNumWorkers[c]);this._next()};b.prototype._next=function(){for(var a=0;a<this.numTypes;++a){if(this._typeNumWorkers[a]<
this._typeWorkerQuota[a]&&this._processQueue(a))return;++a}for(a=0;a<this.numTypes&&!this._processQueue(a);++a);};b.prototype._processQueue=function(a){for(var c=this;0<this._tasks[a].length;)if(this._workerFunc(this._tasks[a].shift(),function(a,b){return c._taskCallback(a,b)}))return this._typeNumWorkers[a]++,this._totalNumWorkers++,!0;return!1};b.prototype._taskCallback=function(a,b){a._cancelled||(this._callbackFunc(a,b),this._taskFinished(a))};Object.defineProperty(b.prototype,"test",{get:function(){var a=
this;return{set workerFunc(b){a._workerFunc=b}}},enumerable:!0,configurable:!0});return b}();f.AsyncWorkerQueue=e});