// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/awaiterHelper ../core/tsSupport/generatorHelper ../core/arrayUtils ../core/maybe ../core/promiseUtils ../core/accessorSupport/decorators".split(" "),function(y,d,z,v,w,p,q,x,m,r,t){Object.defineProperty(d,"__esModule",{value:!0});d.PopupView=function(d){return function(d){function b(){return null!==d&&d.apply(this,arguments)||this}v(b,d);b.prototype.fetchPopupFeatures=
function(a,e){return this._fetchPopupFeaturesAsync(a,e)};b.prototype._fetchPopupFeaturesAsync=function(a,e){return p(this,void 0,void 0,function(){var c,k,n,f,b,h,l,d,u;return q(this,function(g){switch(g.label){case 0:return[4,this.when()];case 1:return g.sent(),[4,this._prepareFetchPopupFeatures(a,e)];case 2:return c=g.sent(),k=c.location,n=c.queryArea,f=c.layerViewsAndGraphics,b=c.clientOnlyGraphics,h=r.resolve(b),l=this._queryLayerPopupFeatures({queryArea:n,layerViewsAndGraphics:f,options:e}),
d=l.map(function(c){return c.promise}),u=r.eachAlwaysValues([h].concat(d)).then(x.flatten),[2,{location:k,clientOnlyGraphics:b,allGraphicsPromise:u,promisesPerLayerView:l}]}})})};b.prototype._queryLayerPopupFeatures=function(a){var e=a.queryArea,c=a.options;return a.layerViewsAndGraphics.map(function(a){var b=a.layerView;a={clientGraphics:a.graphics,event:m.isSome(c)?c.event:null,signal:m.isSome(c)?c.signal:null,defaultPopupTemplateEnabled:m.isSome(c)?!!c.defaultPopupTemplateEnabled:!1};a=b.fetchPopupFeatures(e,
a);return{layerView:b,promise:a}})};b.prototype._isValidPopupGraphic=function(a,e){return a&&!!a.getEffectivePopupTemplate(m.isSome(e)&&e.defaultPopupTemplateEnabled)};b.prototype._prepareFetchPopupFeatures=function(a,e){return p(this,void 0,void 0,function(){var c,b,n,f,g,h,l,d;return q(this,function(k){switch(k.label){case 0:return[4,this._popupHitTestGraphics(a,e)];case 1:return c=k.sent(),b=c.clientGraphics,n=c.queryArea,f=c.location,g=this._getFetchPopupLayerViews(),h=this._graphicsPerFetchPopupLayerView(b,
g),l=h.layerViewsAndGraphics,d=h.clientOnlyGraphics,[2,{clientOnlyGraphics:d,layerViewsAndGraphics:l,queryArea:n,location:f}]}})})};b.prototype._popupHitTestGraphics=function(a,b){return p(this,void 0,void 0,function(){var c,e,d,f,g,h,l=this;return q(this,function(k){switch(k.label){case 0:return[4,this.popupHitTest(a)];case 1:return c=k.sent(),e=c.results,d=c.mapPoint,f=e.filter(function(a){return l._isValidPopupGraphic(a.graphic,b)}),g=f.length?f[0].mapPoint:null,h=f.map(function(a){return a.graphic}),
[2,{clientGraphics:h,queryArea:d,location:d||g}]}})})};b.prototype._getFetchPopupLayerViews=function(){var a=this,b=[];this.allLayerViews.forEach(function(c){a._isValidPopupLayerView(c)&&b.push(c)});m.isSome(this.graphicsView)&&this._isValidPopupLayerView(this.graphicsView)&&b.push(this.graphicsView);return b.reverse()};b.prototype._isValidPopupLayerView=function(a){return m.isSome(a)&&(!("layer"in a)||!a.suspended)&&"fetchPopupFeatures"in a};b.prototype._graphicsPerFetchPopupLayerView=function(a,
b){var c=[],d=new Map;b=b.map(function(a){var b=[];"layer"in a?d.set(a.layer,b):d.set(a.graphics,b);return{layerView:a,graphics:b}});for(var e=0;e<a.length;e++){var f=a[e],g=d.get(f.layer)||null;g?g.push(f):c.push(f)}return{layerViewsAndGraphics:b,clientOnlyGraphics:c}};return b=w([t.subclass("esri.views.PopupView")],b)}(t.declared(d))}});