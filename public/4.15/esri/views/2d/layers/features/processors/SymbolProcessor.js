// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators ../../../../../geometry/SpatialReference ../../../../../layers/support/LabelClass ../../../../../layers/support/labelFormatUtils ../../../../../renderers/support/jsonUtils ../../../engine ../../../arcade/utils ../../../engine/webgl/util/vvFlagUtils ../textUtils ./BaseProcessor".split(" "),
function(v,w,B,f,C,q,k,D,N,E,r,n,e,x,F,G,H,p,I,J,K,L){function M(e,d){e=Array(e);for(var b=0;b<e.length;b++)e[b]=d;return e}Object.defineProperty(w,"__esModule",{value:!0});var y=E.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor");v=function(t){function d(){var b=null!==t&&t.apply(this,arguments)||this;b._symbolToMosaicItemMap=new Map;b._visualSetPromises=new Map;b.type="symbol";return b}B(d,t);d.prototype.initialize=function(){this._factory=this._createFactory()};d.prototype.destroy=
function(){this._visualSetPromises.clear();this._symbolToMosaicItemMap.clear();this.notifyChange("updating")};Object.defineProperty(d.prototype,"supportsTileUpdates",{get:function(){return!0},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"labelingInfo",{get:function(){return!this.config||r.isNone(this.config.labelingInfo)?null:this.config.labelingInfo.map(function(b){return F.fromJSON(b)})},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"labelClassInfos",{get:function(){var b=
this;if(!this.labelingInfo)return n.resolve();var a=function(a){return k(b,void 0,void 0,function(){var c,b,d;return q(this,function(g){switch(g.label){case 0:c=null,g.label=1;case 1:return g.trys.push([1,3,,4]),[4,G.createLabelFunction(a,this.service.fields,this.spatialReference)];case 2:return c=g.sent(),[3,4];case 3:return b=g.sent(),d=a.where?"where":"arcade",y.error(new D("mapview-labeling","Failed to evaluate "+d+" expression",{labelClass:a,error:b})),[3,4];case 4:return[2,c]}})})};return n.all(this.labelingInfo.map(function(c,
d){return k(b,void 0,void 0,function(){var b;return q(this,function(g){switch(g.label){case 0:return b=r.andThen,[4,a(c)];case 1:return[2,b.apply(void 0,[g.sent(),function(a){return{index:d,minScale:c.minScale,maxScale:c.maxScale,builder:a,symbol:c.symbol,symbolJSON:c.symbol.toJSON()}}])]}})})})).then(function(a){return a.filter(function(a){return a})})},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"hydrate",{get:function(){return I.createHydrateFactory(this.service.geometryType)},
enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"renderer",{get:function(){return this.config?H.fromJSON(this.config.renderer):null},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"updating",{get:function(){return 0<this._visualSetPromises.size},enumerable:!0,configurable:!0});d.prototype.update=function(b){return k(this,void 0,void 0,function(){var a;return q(this,function(c){a=this._getMeshHash();this._set("config",b);a!==this._getMeshHash()?this._factory=this._createFactory():
this._factory.update(this.labelingInfo,this.renderer,this.tileStore.tileScheme.tileInfo);return[2]})})};d.prototype.onTileData=function(b,a,c){var d=this;a=this._onTileData(b,a,c);this._visualSetPromises.set(b,a);n.always(a,function(){return d._cleanPromise(b)});this.notifyChange("updating");return a};d.prototype.onTileError=function(b,a,c){var d=this;a=this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:b.id,error:a},{signal:c.signal});this._visualSetPromises.set(b,a);n.always(a,function(){return d._cleanPromise(b)});
this.notifyChange("updating");return a};d.prototype._getMeshHash=function(){var b=J.getVVFlags("visualVariables"in this.renderer&&this.renderer.visualVariables||[]);return this.renderer.getMeshHash()+"."+b};d.prototype._createFactory=function(){var b=this,a=this.service,c=a.geometryType,d=a.objectIdField,a=a.fields,h=x.fromJSON(this.spatialReference),a={geometryType:c,fields:a,spatialReference:h},h=new p.WGLTemplateStore(function(a,c){return b.remoteClient.invoke("tileRenderer.getMaterialItems",a,
c)},!1),e=this.tileStore.tileScheme.tileInfo;this._store=h;this._matcher=p.createMatcher(h,a,this.renderer);return new p.WGLMeshFactory(c,d,this.renderer,h,this.labelingInfo,e)};d.prototype._cleanPromise=function(b){this._visualSetPromises.delete(b);this.notifyChange("updating")};d.prototype._onTileData=function(b,a,c){return k(this,void 0,void 0,function(){var d,h,e,z,m,l,u,f,k,p,A;return q(this,function(g){switch(g.label){case 0:d=a.addOrUpdate,h=a.remove,e=a.clear,z=this._processFeatures(b,d,a.transformParams),
m=c.signal,g.label=1;case 1:return g.trys.push([1,3,,4]),[4,z];case 2:return l=g.sent(),u=r.andThen(l,function(a){return a.message}),f=r.andThen(l,function(a){return a.transferList})||[],k={addOrUpdate:u,remove:h,clear:e},p={transferList:r.unwrap(f)||[],signal:m},[2,this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:b.id,data:k},p)];case 3:return A=g.sent(),this._handleError(b,A,c),[3,4];case 4:return[2]}})})};d.prototype._processFeatures=function(b,a,c){return k(this,void 0,void 0,function(){var d,
h,e,f,m,l;return q(this,function(g){switch(g.label){case 0:d=a&&a.length;if(!d)return[2,null];h=this._factory;e={viewingMode:"",scale:b.scale};return[4,this._matcher];case 1:return f=g.sent(),[4,this._getLabelInfos(b,a,c)];case 2:return m=g.sent(),[4,h.analyze(a,f,c,e)];case 3:return l=g.sent(),[2,this._writeFeatures(b,l,c,m,h)]}})})};d.prototype._writeFeatures=function(b,a,c,d,h){for(var g=h.createMeshData(a.length),e={viewingMode:"",scale:b.scale},m=0;m<a.length;m++){var f=a[m];try{var k=r.isSome(d)?
d.get(f.localId):null;h.write(g,f,c,e,b.level,k)}catch(O){}}return this._encodeDisplayData(g)};d.prototype._encodeDisplayData=function(b){var a={},c=[];b.encode(a,c);return{message:a,transferList:c}};d.prototype._handleError=function(b,a,c){if(!n.isAbortError(a))return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:b.id,error:a.message},{signal:c.signal})};d.prototype._getLabelClassInfosForScale=function(b){return k(this,void 0,void 0,function(){var a;return q(this,function(c){switch(c.label){case 0:return[4,
this.labelClassInfos];case 1:return a=c.sent(),[2,a.filter(function(a){var c=a.minScale;a=a.maxScale;return(!c||c>=b||0===c)&&(!a||a<=b||0===a)})]}})})};d.prototype._shouldDiscard=function(b,a){switch(this.service.geometryType){case "esriGeometryPoint":var c=a.geometry;a=c.x;c=c.y;return b.checkOverlap(a,c);case "esriGeometryPolygon":return c=a.centroid,a=c.x,c=c.y,b.checkOverlap(a,c);default:return!1}};d.prototype._markUsed=function(b,a){switch(this.service.geometryType){case "esriGeometryPoint":var c=
a.geometry;a=c.x;c=c.y;return b.markUsed(a,c);case "esriGeometryPolygon":return c=a.centroid,a=c.x,c=c.y,b.markUsed(a,c)}};d.prototype._getLabelInfos=function(b,a,c){return k(this,void 0,void 0,function(){var d,e,f,k,m,l,u,n,t;return q(this,function(g){switch(g.label){case 0:return this.labelingInfo&&a&&0!==a.length?[4,this._getLabelClassInfosForScale(b.scale)]:[2,null];case 1:d=g.sent();if(0===d.length)return[2,null];e=new Map;f=new p.CollisionGrid(p.definitions.COLLISION_EARLY_REJECT_BUCKET_SIZE);
k=function(a){var b=a.localId;if(m._shouldDiscard(f,a))return e.set(b,null),"continue";for(var g=M(d.length,null),k=!1,h=function(b){b=d[b];var e=b.index,f=b.builder;b=b.symbolJSON;if(!c)return y.error("mapview-labeling","Tried to evaluate geometry expression but no transformation found"),{value:void 0};var h=m.hydrate(a.geometry,c.transform,c.hasZ,c.hasM),l=C({},a,{geometry:h});h.spatialReference=x.fromJSON(m.spatialReference);f=f.evaluate(l);if(r.isNone(f)||""===f)return"continue";var f=p.bidiText(f),
h=f[0],n=f[1];k=!0;m._store.getMosaicItem(b,!1,K.codepoints(h)).then(function(a){g[e]={glyphs:a.glyphMosaicItems,rtl:n,classIndex:e}})},l=0;l<d.length;l++){var n=h(l);if("object"===typeof n)return n}e.set(b,g);k&&m._markUsed(f,a)};m=this;l=0;for(u=a;l<u.length;l++)if(n=u[l],t=k(n),"object"===typeof t)return[2,t.value];return[2,e]}})})};f([e.property({readOnly:!0})],d.prototype,"supportsTileUpdates",null);f([e.property()],d.prototype,"config",void 0);f([e.property({dependsOn:["config"]})],d.prototype,
"labelingInfo",null);f([e.property({dependsOn:["labelingInfo","service","spatialReference"]})],d.prototype,"labelClassInfos",null);f([e.property({dependsOn:["service"]})],d.prototype,"hydrate",null);f([e.property({dependsOn:["config"],readOnly:!0})],d.prototype,"renderer",null);f([e.property({readOnly:!0})],d.prototype,"updating",null);return d=f([e.subclass("esri.views.2d.layers.features.processors.SymbolProcessor")],d)}(e.declared(L.default));w.default=v});