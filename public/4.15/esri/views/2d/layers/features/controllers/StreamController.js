// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/Error ../../../../../core/has ../../../../../core/MapUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/data/executeTileQuery ../../../../../layers/graphics/data/FeatureStore ../../../../../layers/graphics/data/StreamFeatureManager ../../../../../layers/graphics/sources/connections/GeoEventConnection ./BaseController ./support/DispatchQueue".split(" "),
function(p,q,A,k,K,m,n,r,L,B,l,t,g,C,D,E,F,G,H,I){Object.defineProperty(q,"__esModule",{value:!0});var J=function(){function f(a,b){this.store=a;this.onUpdate=b}f.prototype.add=function(a){this.store.add(a)};f.prototype.forEach=function(a){this.store.forEach(a)};f.prototype.removeById=function(a){return this.store.removeById(a)};f.prototype.update=function(a,b){this.onUpdate(a,b)};Object.defineProperty(f.prototype,"size",{get:function(){return this.store.numFeatures},enumerable:!0,configurable:!0});
return f}();p=function(f){function a(){var b=null!==f&&f.apply(this,arguments)||this;b.type="stream";b._tileDispatchMap=new Map;b._updateIntervalId=0;return b}A(a,f);a.prototype.initialize=function(){var b=this,a=this.service,d=a.objectIdField,e=a.timeInfo,h=a.purgeOptions;this.connection=new G.default(a.source,a.spatialReference,this.spatialReference,a.geometryType,a.serviceFilter);this._set("store",new E.default(this.geometryInfo));this._set("streamFeatureManager",new F.default(new J(this.store,
function(a,c){return b._onUpdate(a,c)}),d,e,h));this.connection.on("feature",function(a){return b._onFeature(a)});["connectionStatus","errorString"].forEach(function(a){b.watch("connection."+a,function(c){return b.remoteClient.invoke("setProperty",{propertyName:a,value:c})})});this._updateIntervalId=setInterval(function(){return b.streamFeatureManager.checkForUpdates()},64);this._shouldPushDataReceived=this.service.enableDataReceived};a.prototype.destroy=function(){clearInterval(this._updateIntervalId);
this.connection.destroy();this.queryEngine.destroy();this._tileDispatchMap.forEach(function(b){return b.destroy()})};Object.defineProperty(a.prototype,"queryEngine",{get:function(){return this._createQueryEngine(this.store)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"updating",{get:function(){return this._tempQueryEngine&&!!this._tempQueryEngine.featureStore.numFeatures||this._anyUpdatesQueued()},enumerable:!0,configurable:!0});a.prototype.update=function(b){return n(this,
void 0,void 0,function(){var a,d,e=this;return m(this,function(c){switch(c.label){case 0:return this.validateConfig(b),JSON.stringify(this.service.serviceFilter),a=this.renderer.getAttributeHash(),this._set("config",b),[4,this.updatePixelBuffer()];case 1:c.sent();JSON.stringify(this.service.serviceFilter);if("heatmap"===this.renderer.type)return[2];if(a===this.renderer.getAttributeHash())return[3,3];d=this.queryEngine.featureStore;return[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)];
case 2:c.sent(),d.forEach(function(b){return e.attributeStore.setAttributeData(b.localId,b,e.geometryInfo,e.viewParams)}),c.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return c.sent(),[4,this.attributeStore.sendUpdates()];case 5:return c.sent(),[2]}})})};a.prototype.invalidate=function(){this._repushActiveTiles()};a.prototype.onEdits=function(){};a.prototype.queryFeatures=function(b){return this.queryEngine.executeQuery(b)};a.prototype.queryFeatureCount=function(b){return this.queryEngine.executeQueryForCount(b)};
a.prototype.queryObjectIds=function(b){return this.queryEngine.executeQueryForIds(b)};a.prototype.queryExtent=function(b){return this.queryEngine.executeQueryForExtent(b)};a.prototype.queryLatestObservations=function(b){return n(this,void 0,void 0,function(){return m(this,function(a){if(!this.service.timeInfo.trackIdField)throw r("mapview-no-trackIdField","queryLatestObservation can only be used with services that define a TrackIdField");return[2,this.queryEngine.executeQueryForLatestObservations(b)]})})};
a.prototype.queryStatistics=function(){throw r("Method not implemented.");};a.prototype.refresh=function(){};a.prototype.setViewState=function(){var b=this,a=this.viewState&&this.viewState.scale;this.inherited(arguments);a!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.queryEngine.featureStore.forEach(function(a){return b.attributeStore.setAttributeData(a.localId,a,b.geometryInfo,b.viewParams)}),this.attributeStore.sendUpdates())};a.prototype.onTileUpdate=function(b){var a=this,d=
b.added;b.removed.forEach(function(b){return a._handleTileRemove(b)});d.forEach(function(b){return a._handleTileAdd(b)})};a.prototype.enableEvent=function(b){"data-received"===b.name&&(this._shouldPushDataReceived=b.value)};a.prototype._onFeature=function(b){this._shouldPushDataReceived&&this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:b.attributes,centroid:b.centroid,geometry:b.geometry}});try{var a=this.geometryInfo,d=C.convertFromFeature(b,a.geometryType,a.hasZ,a.hasM,
this.service.objectIdField);this.streamFeatureManager.add(d)}catch(e){}};a.prototype._createStoreWithFeatures=function(b){if(l.isNone(b))return null;var a=this._createFeatureStore();a.addMany(b);return a};a.prototype._onUpdate=function(b,a){return n(this,void 0,void 0,function(){var c,e,h=this;return m(this,function(d){switch(d.label){case 0:return l.isSome(b)&&b.forEach(function(b){return h.onFeatureAdd(b)}),c=this._createStoreWithFeatures(b),e=this._createStoreWithFeatures(a),this.attributeStore.sendUpdates(),
this.processor.supportsTileUpdates?[4,this._updateActiveTiles(c,e)]:[3,2];case 1:return d.sent(),[3,3];case 2:this._repushActiveTiles(),d.label=3;case 3:return l.isSome(a)&&a.forEach(function(b){return h.onFeatureRemove(b)}),[2]}})})};a.prototype._handleTileAdd=function(b){if(this._tileDispatchMap.has(b.id)){var a=this._tileDispatchMap.get(b.id);a.up()}else a=new I.default,this._tileDispatchMap.set(b.id,a);this._queryTileFeatures(b,!0,this.queryEngine)};a.prototype._handleTileRemove=function(b){var a=
this._tileDispatchMap.get(b.id);a&&(a.destroy(),this._tileDispatchMap.delete(b.id))};a.prototype._anyUpdatesQueued=function(){return B.valuesOfMap(this._tileDispatchMap).some(function(a){return a.hasAction()})};a.prototype._updateActiveTiles=function(a,c){return n(this,void 0,void 0,function(){var b,e,h=this;return m(this,function(d){switch(d.label){case 0:return b=l.applySome(a,function(a){return h._createQueryEngine(a)}),e=l.applySome(c,function(a){return h._createQueryEngine(a)}),[4,t.all(this.tileStore.tiles.map(function(a){return h._queryTileFeatures(a,
!1,b,e)}))];case 1:return d.sent(),[2]}})})};a.prototype._repushActiveTiles=function(){for(var a=0,c=this.tileStore.tiles;a<c.length;a++)this._queryTileFeatures(c[a],!0,this.queryEngine)};a.prototype._queryTileFeatures=function(a,c,d,e){return n(this,void 0,void 0,function(){var b,f,g,k,p,u,q,r,x,y,v,z,w=this;return m(this,function(h){switch(h.label){case 0:b={hasZ:!1,hasM:!1,transform:{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]}};f=this.queryInfo;
g=f.returnCentroid;k=f.returnGeometry;p=this._pixelBuffer;u={returnCentroid:g,returnGeometry:k,pixelBuffer:p,returnOutline:this.returnOutline};if(!this._tileDispatchMap.has(a.id))return[2];q=this._tileDispatchMap.get(a.id);return[4,l.applySome(d,function(b){return b.featureStore.executeTileQuery(a,w.spatialReference,u)})];case 1:return r=h.sent(),x=l.mapOr(r,[],function(a){return a.features}),y=l.mapOr(e,[],function(b){return D.executeTileQueryForIds(b,a,u)}).map(function(a){return w.attributeStore.getLocalId(a)}),
v=t.createResolver(),z=function(d){return n(w,void 0,void 0,function(){var f;return m(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.processor.onTileData(a,{addOrUpdate:x,remove:y,clear:c,transformParams:b},{signal:d})];case 1:return e.sent(),[3,3];case 2:return f=e.sent(),t.throwIfNotAbortError(f),[3,3];case 3:return v.resolve(),[2]}})})},q.enqueue(z),[2,v.promise]}})})};k([g.property()],a.prototype,"connection",void 0);k([g.property()],a.prototype,"service",void 0);
k([g.property({readOnly:!0})],a.prototype,"store",void 0);k([g.property({readOnly:!0})],a.prototype,"streamFeatureManager",void 0);k([g.property({readOnly:!0,dependsOn:["store","service","config"]})],a.prototype,"queryEngine",null);k([g.property()],a.prototype,"updating",null);return a=k([g.subclass("esri.views.2d.layers.features.controllers.StreamController")],a)}(g.declared(H.default));q.default=p});