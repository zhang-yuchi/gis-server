// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../geometry ../../../../../core/has ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/screenUtils ../../../../../geohash/GeohashTree ../../../../../geohash/geohashUtils ../../../../../geometry/support/spatialReferenceUtils ../../../../../geometry/support/webMercatorUtils ../../../../../layers/graphics/OptimizedFeature ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/data/FeatureStore ../../../../../layers/graphics/data/projectionSupport ../../../../../layers/graphics/data/QueryEngine ../../../../../layers/graphics/data/utils ../../../../../support/arcadeOnDemand ../../../arcade/utils ../../../engine/webgl/definitions".split(" "),
function(H,I,J,z,x,D,A,Z,h,O,P,K,F,Q,E,R,S,T,B,L,M,U,V,l){function W(h,d,a){return D(this,void 0,void 0,function(){var b,c,g,e;return x(this,function(m){b=[];c=0;for(g=h;c<g.length;c++)e=g[c],b.push(X(e,d,a));return[2,O.all(b)]})})}function X(h,d,a){return D(this,void 0,void 0,function(){var b,c,g;return x(this,function(e){switch(e.label){case 0:if(!("onStatisticValueExpression"in h.outStatistic))return[3,2];b=h;c=b.outStatistic.onStatisticValueExpression;g=b;return[4,U.createRendererExpression(c,
d,a)];case 1:return g.expression=e.sent(),[2,b];case 2:return[2,h]}})})}Object.defineProperty(I,"__esModule",{value:!0});var N=function(l){return h.andThen(l,function(d){return"cluster"!==d.type?null:z({},d,{clusterRadius:P.pt2px(d.clusterRadius/2)})})},Y=function(h){function d(a,b,c,g,e){var m=this;b=new S.default([],[b,c]);m=h.call(this,b,g,null,a)||this;m.invalid=!1;m.canDelete=!1;m.geohashBoundsInfo=e;return m}J(d,h);Object.defineProperty(d.prototype,"count",{get:function(){return this.attributes.cluster_count},
enumerable:!0,configurable:!0});d.create=function(a,b,c,g,e,m,f){b=new d(b,c,g,m,f);b.localId=a.createLocalId(b.objectId,!0);b.tileLevel=e;return b};d.prototype.update=function(a,b,c,g,e){this.geometry.coords[0]=a;this.geometry.coords[1]=b;this.tileLevel=c;this.attributes=g;this.geohashBoundsInfo=e;this.referenceId=null;this.invalid=!1;return this};d.prototype.toJSON=function(){return{objectId:this.objectId,referenceId:this.referenceId,attributes:z({},this.attributes,{clusterId:this.objectId}),geometry:{x:this.geometry.coords[0],
y:this.geometry.coords[1]}}};return d}(R.default);H=function(v){function d(a,b,c,g){a=v.call(this,a)||this;a._deferredDeletionQueue=[];a._invalidated=!1;a._aggregateFieldsHash=null;a._geohashLevel=0;a._aggregateValueRanges={};a._aggregateValueRangesChanged=!1;a._aggregateFields=[];a._hasAggregateValueExpression=!1;a._hasViewExpression=!1;a._$view={scale:0,viewingMode:"none"};a._clusters=new Map;a._tiles=new Map;a._spatialReference=b;a._attributeStore=c;a._featureReduction=N(g);a._projectionSupportCheck=
B.checkProjectionSupport(b,A.SpatialReference.WGS84);return a}J(d,v);d.prototype.setScale=function(a){var b=a!==this._$view.scale&&this._hasViewExpression,c=this._featureReduction;this._$view.scale=a;h.isSome(c)&&b&&(this._tree=new K.GeohashTree(this._aggregateFields),this._unindexFeatures(),this._reindexFeatures(!0))};d.prototype.update=function(a,b,c){return D(this,void 0,void 0,function(){var g,e,m,d,l,q,t,n,k,p,r,w=this;return x(this,function(f){switch(f.label){case 0:g=this._featureReduction;
e=h.andThen(b.featureReduction,N);m=b.aggregateFields.reduce(function(a,b){return a+JSON.stringify(b)},"");d=null===g&&b.featureReduction;l=m!==this._aggregateFieldsHash;q=d||l;if(!l)return[3,2];t=this;return[4,W(b.aggregateFields,this._spatialReference,c)];case 1:t._aggregateFields=f.sent();this._hasViewExpression=!1;n=0;for(k=this._aggregateFields;n<k.length;n++)p=k[n],"onStatisticValueExpression"in p.outStatistic&&(r=p,this._hasAggregateValueExpression=!0,this._hasViewExpression=this._hasViewExpression||
r.expression.referencesScale());f.label=2;case 2:return[4,this._projectionSupportCheck];case 3:f.sent();this._featureReduction=e;this._aggregateFieldsHash=m;this._aggregateValueRanges={};this._invalidated=!0;if(h.isNone(e))return this._tree=null,[2];h.isSome(g)&&g.clusterRadius!==e.clusterRadius&&this._clusters.forEach(function(a){return a.canDelete=!0});q&&(this._tree=new K.GeohashTree(b.aggregateFields),this._unindexFeatures());(q||a)&&this._reindexFeatures(l);this._handleClusterUpdates();this._tiles.forEach(function(a){return w._getClustersForTile(a,
0,e.clusterRadius,null,!1)});return[2]}})})};d.prototype._ensureAggregateFields=function(a){if(this._hasAggregateValueExpression)for(var b=this._$view,c=0,g=this._aggregateFields;c<g.length;c++){var e=g[c];"onStatisticValueExpression"in e.outStatistic&&(a.attributes[e.outStatistic.onStatisticField]=V.callWithOptimizedFeature(e.expression,a,{$view:b},this.geometryInfo))}};d.prototype._unindexFeatures=function(){this._featuresById.forEach(function(a){a.geohashIndexed=!1})};d.prototype._reindexFeatures=
function(a){var b=this;this._featuresById.forEach(function(c){c.geohashX||c.geohashY||b._setGeohash(c);a&&b._ensureAggregateFields(c);b._attributeStore.isVisible(c)?b._insertIntoIndex(c):b._removeFromIndex(c)})};d.prototype.onTileUpdate=function(a){var b=this,c=a.added;a=a.removed;if(c.length){var g=Math.max.apply(Math,c.map(function(a){return a.level}));this._setGeohashLevel(g);c.forEach(function(a){return b._tiles.set(a.key.id,a)})}if(!h.isNone(this._featureReduction)){var e=this._featureReduction.clusterRadius;
a.forEach(function(a){b._tiles.delete(a.key.id);b._markTileClustersForDeletion(a,e)})}};d.prototype.sweepClusters=function(){var a=this;this._clusters.forEach(function(b,c){b.canDelete&&(a._attributeStore.freeLocalId(b.objectId),a._clusters.delete(c))});for(var b=0,c=this._deferredDeletionQueue;b<c.length;b++)this._attributeStore.addLocalId(c[b]);this._deferredDeletionQueue=[]};d.prototype.executeTileQuery=function(a,b,c){return D(this,void 0,void 0,function(){var g,e,d;return x(this,function(f){switch(f.label){case 0:return h.isNone(this._featureReduction)?
[2,v.prototype.executeTileQuery.call(this,a,b,c)]:[4,this._projectionSupportCheck];case 1:return f.sent(),this._handleClusterUpdates(),g=this._featureReduction.clusterRadius,e=this._getTransforms(a,b),d=this._getClustersForTile(a,c.pixelBuffer,g,e),this._aggregateValueRangesChanged&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),[2,d]}})})};d.prototype.getAggregate=function(a){var b=null;this._clusters.forEach(function(c){c.localId===
a&&(b=c.toJSON())});return b};d.prototype.getAggregateValueRanges=function(){return this._aggregateValueRanges};d.prototype._getClustersForTile=function(a,b,c,g,e){var d=this;void 0===e&&(e=!0);b=Math.max(b,50);var f=2*c,G=new Set,q=this._getGeohashLevel(a.key.level),t=Math.pow(2,a.key.level)*Math.ceil(l.TILE_SIZE/f),n=Math.ceil(b/f)+2;c=Math.ceil(l.TILE_SIZE/f)+2*n;var k=a.key;b=Math.floor(k.col*l.TILE_SIZE/f)-n;f=Math.floor(k.row*l.TILE_SIZE/f)-n;n=b+c;c=f+c;for(var p=[],r=a.tileInfoView.getLODInfoAt(a.key.level),
w=b;w<=n;w++){b=function(b){var c,f,m=w;r.wrap&&(m=0>w?w+t:w%t);var n=r.wrap&&0>w,l=r.wrap&&w%t!==w;b=y._lookupCluster(r,a.key.level,m,b,q);if(h.isSome(b)){m=h.andThen(g,function(a){return n?a.left:l?a.right:a.tile});if(e&&h.isNone(m)||!b.count)return"continue";if(e&&1===b.count){var k=b.geohashBoundsInfo,u=k.xLL;f=k.yLL;c=k.xTR;var v=k.yTR,k=k.level,u=h.expect(y._tree).findSingleOccupancyNode(u,f,c,v,k),u=h.unwrap(u).getLngLatBounds(),k={x:u[0],y:u[1]};f={x:u[2],y:u[3]};var x=v=c=u=0;if(y._spatialReference.isWebMercator)c=
E.lngLatToXY(k.x,k.y),u=c[0],c=c[1],f=E.lngLatToXY(f.x,f.y),v=f[0],x=f[1];else{c=B.project(k,A.SpatialReference.WGS84,y._spatialReference);f=B.project(f,A.SpatialReference.WGS84,y._spatialReference);if(!c||!f)return"continue";u=c.x;c=c.y;v=f.x;x=f.y}var C=null;y.forEachInBounds([u,c,v,x],function(a){d._attributeStore.isVisible(a)&&(C=a)});if(!C)return"continue";m=M.getGeometry(y.geometryInfo,C.geometry,0,h.expect(m));u=z({},C.attributes,b.attributes);b.referenceId=C.localId;G.add(b.objectId);p.push(new L.Feature(u,
b.localId,m))}else e&&(G.add(b.objectId),m=M.getGeometry(y.geometryInfo,b.geometry,0,h.expect(m)),p.push(new L.Feature(b.attributes,b.localId,m)))}};for(var y=this,k=f;k<=c;k++)b(k)}return{features:p,objectIds:G}};d.prototype._getGeohashLevel=function(a){return Math.min(Math.ceil(a/2+2),12)};d.prototype._setGeohashLevel=function(a){var b=this,c=this._geohashLevel;a=this._getGeohashLevel(a);a=2*(Math.floor(a/2)+1)-1;var g=this._tree;this._geohashLevel=a;h.isNone(g)||(a>c?this._featuresById.forEach(function(a){a.geohashIndexed&&
(g.insert(a,b._geohashLevel,c+1),a.geohashIndexed=!0)}):a<c&&g.dropLevels(this._geohashLevel))};d.prototype._insertIntoIndex=function(a){a.geohashIndexed||(this._invalidated=!0,a.geohashIndexed=!0,h.expect(this._tree).insert(a,this._geohashLevel))};d.prototype._removeFromIndex=function(a){a.geohashIndexed&&(this._invalidated=!0,h.expect(this._tree).remove(a,this._geohashLevel),a.geohashIndexed=!1)};d.prototype._handleClusterUpdates=function(){var a=this;this._invalidated&&this._clusters.size&&this._clusters.forEach(function(b){h.isSome(b)&&
(b.invalid=b.invalid||a._invalidated)});this._invalidated=!1};d.prototype._getTransforms=function(a,b){var c={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]};b=Q.getInfo(b);if(!b)return{tile:c,left:null,right:null};var g=b.valid;b=g[0];var e=g[1],g=z({},c,{translate:[e,a.bounds[3]]});a=z({},c,{translate:[b-e+a.bounds[0],a.bounds[3]]});return{tile:c,left:g,right:a}};d.prototype._getClusterId=function(a,b,c){return(a&15)<<28|(b&16383)<<14|c&16383};d.prototype._markForDeletion=
function(a,b,c){a=this._getClusterId(a,b,c);this._clusters.has(a)&&(b=this._clusters.get(a),h.isSome(b)?b.canDelete=!0:this._clusters.delete(a))};d.prototype._getClusterBounds=function(a,b,c){if(h.isNone(this._featureReduction))return null;var g=this._featureReduction.clusterRadius,e=2*g;b=c%2?b*e:b*e+g;var d=c*e,g=d/l.TILE_SIZE;c=(b+e)/l.TILE_SIZE;e=(d-e)/l.TILE_SIZE;b=a.getXForColumn(b/l.TILE_SIZE);g=a.getYForRow(g);c=a.getXForColumn(c);a=a.getYForRow(e);return[b,g,c,a]};d.prototype._lookupCluster=
function(a,b,c,g,e){var d,f;if(h.isNone(this._featureReduction)||h.isNone(this._tree))return null;var l=this._getClusterId(b,c,g),q=this._clusters.get(l);if(q&&h.isSome(q)&&!q.invalid&&!q.canDelete)return q;var t=this._getClusterBounds(a,c,g);a=t[0];c=t[1];g=t[2];var t=t[3],n={x:a,y:c};f={x:g,y:t};var k=0,p=d=0,r=0;if(this._spatialReference.isWebMercator)d=E.xyToLngLat(n.x,n.y),k=d[0],d=d[1],f=E.xyToLngLat(f.x,f.y),p=f[0],r=f[1];else{d=B.project(n,this._spatialReference,A.SpatialReference.WGS84);
f=B.project(f,this._spatialReference,A.SpatialReference.WGS84);if(!d||!f)return null;k=d.x;d=d.y;p=f.x;r=f.y}n={geohashX:0,geohashY:0};f={geohashX:0,geohashY:0};F.setGeohashXY(n,d,k,e);F.setGeohashXY(f,r,p,e);d=n.geohashX;p=n.geohashY;r=f.geohashX;f=f.geohashY;k={xLL:d,yLL:p,xTR:r,yTR:f,level:e};p=this._tree.getRegionStatistics(d,p,r,f,e);e=p.count;d=p.xTotal;f=p.yTotal;d=e?d/e:0;f=e?f/e:0;h.isSome(q)&&q.canDelete&&(r=this._attributeStore.removeLocalId(q.objectId),this._deferredDeletionQueue.push(r));
r=h.isSome(q)&&!q.canDelete&&q.invalid;p=z({cluster_count:e},p.attributes);n=this._attributeStore;b=r?q.update(d,f,b,p,k):Y.create(n,l,d,f,b,p,k);0===e&&(b.geometry.coords[0]=(a+g)/2,b.geometry.coords[1]=(c+t)/2);this._attributeStore.setAttributeData(b.localId,b,this.geometryInfo,null);this._clusters.set(l,b);this._updateAggregateValueRangeForCluster(b,b.tileLevel);return b};d.prototype._updateAggregateValueRangeForCluster=function(a,b){var c=this._aggregateValueRanges[b]||{minValue:Infinity,maxValue:0},
d=c.minValue,e=c.maxValue;c.minValue=Math.min(d,a.count);c.maxValue=Math.max(e,a.count);this._aggregateValueRanges[b]=c;if(d!==c.minValue||e!==c.maxValue)this._aggregateValueRangesChanged=!0};d.prototype._markTileClustersForDeletion=function(a,b){var c=2*b;b=Math.ceil(l.TILE_SIZE/c);for(var d=a.key,e=Math.floor(d.col*l.TILE_SIZE/c),c=Math.floor(d.row*l.TILE_SIZE/c),d=e;d<e+b;d++)for(var h=c;h<c+b;h++)this._markForDeletion(a.key.level,d,h)};d.prototype._setGeohash=function(a){var b=a.geometry;b&&b.coords.length&&
(b=B.project({x:b.coords[0],y:b.coords[1]},this._spatialReference,A.SpatialReference.WGS84))&&F.setGeohashXY(a,b.y,b.x,12)};d.prototype._add=function(a){var b=this._featuresById.get(a.objectId);v.prototype._add.call(this,a);this._ensureAggregateFields(a);h.isSome(this._featureReduction)&&h.isSome(this._tree)&&(b?(a.geohashIndexed=b.geohashIndexed,a.geohashX=b.geohashX,a.geohashY=b.geohashY):this._setGeohash(a),!a.geohashIndexed&&this._attributeStore.isVisible(a)&&this._insertIntoIndex(a))};d.prototype._remove=
function(a){h.isSome(this._featureReduction)&&h.isSome(this._tree)&&this._removeFromIndex(a);return v.prototype._remove.call(this,a)};return d}(T.default);I.ClusterStore=H});