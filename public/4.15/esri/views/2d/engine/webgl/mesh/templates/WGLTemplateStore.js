// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/awaiterHelper ../../../../../../core/tsSupport/generatorHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/promiseUtils ../../../../../../symbols/support/defaults ./WGLDynamicLineTemplate ./WGLDynamicMarkerTemplate ./WGLDynamicTextTemplate ./WGLFillTemplate ./WGLLineTemplate ./WGLMarkerTemplate ./WGLTextTemplate ../../util/Lock ../../util/Result ../../../../layers/features/textUtils".split(" "),function(t,
n,f,h,u,A,m,p,B,C,D,q,v,r,w,x,k,E){function l(e,a){var b=e.length;e.push(null);a.then(function(a){return e[b]=a});return e}function y(e){return!!(e&1)}Object.defineProperty(n,"__esModule",{value:!0});var g=A.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),z=[];n.isDynamicId=y;t=function(){function e(a,b){this._templateIdCounter=this._idCounter=1;this._idToTemplateGroup=new Map;this._symbolToTemplate=new Map;this._fetchQueue=[];this._idToResolver=new Map;this._cimTemplateCache=
new Map;this._cimAnalyses=[];this._lock=new x.default;this._fetchResource=a;this._joinOnUTurn=b}Object.defineProperty(e.prototype,"_markerError",{get:function(){return this._errorTemplates.marker[0]},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"_fillError",{get:function(){return this._errorTemplates.fill[0]},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"_lineError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,
"_textError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0});e.prototype.createTemplateGroup=function(a,b,c){this._initErrorTemplates();var d=a.hash();if(this._symbolToTemplate.has(d)&&"expanded-cim"!==a.type)return this._symbolToTemplate.get(d);var e=[];b&&this._createMeshTemplates(e,b,c,!0);this._createMeshTemplates(e,a,c,!1);a=this._createGroupId("expanded-cim"===a.type);this._idToTemplateGroup.set(a,e);this._symbolToTemplate.set(d,a);return a};e.prototype.getTemplateGroup=
function(a){return this._idToTemplateGroup.has(a)?this._idToTemplateGroup.get(a):z};e.prototype.getDynamicTemplateGroup=function(a){if(!this._idToTemplateGroup.has(a))return z;y(a)||g.error("mapview-template-store","Id "+a+" does not refer to a dynamic template");return this._idToTemplateGroup.get(a)};e.prototype.getMosaicItem=function(a,b,c){var d=this,e=this._createTemplateId(),F=m.create(function(a){return d._idToResolver.set(e,a)});a=b?a.toJSON():a;this._fetchQueue.push({symbol:a,id:e,glyphIds:c});
return F};e.prototype.finalize=function(a){return this._fetchQueue.length||this._lock.isHeld()?x.withLock(this._lock,this._fetchAllQueuedResources.bind(this),a):m.resolve()};e.prototype._initErrorTemplates=function(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],p.errorPolygonSymbol2D,null,!1),marker:this._createMeshTemplates([],p.errorPointSymbol2D,null,!1),line:this._createMeshTemplates([],p.errorPolylineSymbol2D,null,!1)})};e.prototype._fetchAllQueuedResources=
function(a){var b=this;if(!this._fetchQueue.length)return m.resolve();var c=this._fetchQueue,d=this._cimAnalyses;this._fetchQueue=[];this._cimAnalyses=[];return m.all(d).then(function(){return b._fetchResource(c,a).then(function(a){for(var c=0;c<a.length;c++){var d=a[c],e=d.id,d=d.mosaicItem;b._idToResolver.get(e)(d);b._idToResolver.delete(e)}})}).catch(function(a){m.isAbortError(a)?b._fetchQueue=b._fetchQueue.concat(c):g.error(u("mapview-template-store","Unable to fetch requested texture resources",
a))})};e.prototype._createGroupId=function(a){return this._idCounter++<<1|(a?1:0)};e.prototype._createTemplateId=function(){return this._templateIdCounter++};e.prototype._createSMS=function(a,b){return f(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return[4,this.getMosaicItem(a,!0)];case 1:return c=d.sent().spriteMosaicItem,k.ok(c,g)?[2,r.default.fromSimpleMarker(b,a,c)]:[2,this._markerError]}})})};e.prototype._createPMS=function(a,b){return f(this,void 0,void 0,
function(){var c;return h(this,function(d){switch(d.label){case 0:return[4,this.getMosaicItem(a,!0)];case 1:return c=d.sent().spriteMosaicItem,k.ok(c,g)?[2,r.default.fromPictureMarker(b,a,c)]:[2,this._markerError]}})})};e.prototype._createSFS=function(a,b,c){return f(this,void 0,void 0,function(){var d,e;return h(this,function(f){switch(f.label){case 0:return[4,this.getMosaicItem(a,!0)];case 1:return d=f.sent().spriteMosaicItem,e=a,k.ok(d,g)?[2,q.default.fromSimpleFill(b,e,d,c)]:[2,this._fillError]}})})};
e.prototype._createPFS=function(a,b,c){return f(this,void 0,void 0,function(){var d,e;return h(this,function(f){switch(f.label){case 0:return[4,this.getMosaicItem(a,!0)];case 1:return d=f.sent().spriteMosaicItem,e=a,k.ok(d,g)?[2,q.default.fromPictureFill(b,e,d,c)]:[2,this._fillError]}})})};e.prototype._createSLS=function(a,b,c){return f(this,void 0,void 0,function(){var d,e;return h(this,function(f){switch(f.label){case 0:return[4,this.getMosaicItem(a,!0)];case 1:return d=f.sent().spriteMosaicItem,
e=a,k.ok(d,g)?[2,v.default.fromSimpleLine(b,c,e,d,this._joinOnUTurn)]:[2,this._lineError]}})})};e.prototype._createTS=function(a,b){return f(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return[4,this.getMosaicItem(a,!0)];case 1:return c=d.sent().glyphMosaicItems,[2,w.default.fromText(b,a,c)]}})})};e.prototype._createCIMText=function(a,b){return f(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return"function"===typeof a.materialHash?
[2,m.resolve(D.default.fromCIMText(b,a))]:[4,this.getMosaicItem(a.cim,!1,E.codepoints(a.text))];case 1:return c=d.sent().glyphMosaicItems,a.cim.mosaicHash=a.materialHash,k.ok(c,g)?[2,w.default.fromCIMText(b,a,c)]:[2,this._textError]}})})};e.prototype._createCIMFill=function(a,b){return f(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:return a.cim.mosaicHash=a.materialHash,[4,this.getMosaicItem(a.cim,!1)];case 1:return c=d.sent().spriteMosaicItem,k.ok(c,g)?[2,
q.default.fromCIMFill(b,a,c,!1)]:[2,this._fillError]}})})};e.prototype._createCIMLine=function(a,b){return f(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:if("function"===typeof a.materialHash)return[2,m.resolve(B.default.fromCIMLine(b,a))];a.cim.mosaicHash=a.materialHash;return[4,this.getMosaicItem(a.cim,!1)];case 1:return c=d.sent().spriteMosaicItem,k.ok(c,g)?[2,v.default.fromCIMLine(b,a,c,!1,this._joinOnUTurn)]:[2,this._lineError]}})})};e.prototype._createCIMMarker=
function(a,b){return f(this,void 0,void 0,function(){var c;return h(this,function(d){switch(d.label){case 0:if("function"===typeof a.materialHash)return[2,m.resolve(C.default.fromCIMMarker(b,a))];a.cim.mosaicHash=a.materialHash;return[4,this.getMosaicItem(a.cim,!1)];case 1:return c=d.sent().spriteMosaicItem,k.ok(c,g)?[2,r.default.fromCIMMarker(b,a,c)]:[2,this._markerError]}})})};e.prototype._createCIM=function(a,b){return f(this,void 0,void 0,function(){var c,d,e=this;return h(this,function(f){c=
a.templateHash;if(this._cimTemplateCache.has(c))return[2,this._cimTemplateCache.get(c)];switch(a.type){case "marker":d=this._createCIMMarker(a,b);break;case "line":d=this._createCIMLine(a,b);break;case "fill":d=this._createCIMFill(a,b);break;case "text":d=this._createCIMText(a,b)}d.then(function(a){return e._cimTemplateCache.set(c,a)});return[2,d]})})};e.prototype._createMeshTemplates=function(a,b,c,d){if(-1!==b.type.indexOf("3d"))return g.error("3D symbols are not supported with MapView"),a;switch(b.type){case "cim":return g.error(u("mapview-bad-type",
"Found a cim type not yet expanded")),a;case "expanded-cim":d=0;for(b=b.layers;d<b.length;d++)l(a,this._createCIM(b[d],c));return a;case "simple-marker":return l(a,this._createSMS(b,c));case "picture-marker":return l(a,this._createPMS(b,c));case "simple-fill":return l(a,this._createSFS(b,c,d)),b.outline&&l(a,this._createSLS(b.outline,c,!0)),a;case "picture-fill":return l(a,this._createPFS(b,c,d)),b.outline&&l(a,this._createSLS(b.outline,c,!0)),a;case "simple-line":return l(a,this._createSLS(b,c,!1));
case "text":return l(a,this._createTS(b,c));default:return g.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),a}};return e}();n.WGLTemplateStore=t});