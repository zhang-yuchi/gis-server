// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/mathUtils ../../../../../../core/mathUtils ../../../../../../core/maybe ../../../../../../core/screenUtils ../../../../engine ../../color ../../definitions ../../enums ../../number ../../WGLDisplayRecord ../../collisions/Metric ../../materialKey/MaterialKey ./segmentUtils ./WGLTextTemplate".split(" "),function(B,x,G,H,I,C,v,p,J,y,D,K,L,m,M,E,w,F,
N){Object.defineProperty(x,"__esModule",{value:!0});var O=I.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate");x.isMapAligned=function(h){switch(h){case "above-along":case "below-along":case "center-along":return 1;default:return 0}};var P=function(h){var e=new Map;return function(a){e.has(a)||e.set(a,h(a));return e.get(a)}}(function(h){var e=0;if(0===h)return Infinity;for(;!(h%2);)e++,h/=2;return e}),z=function(h,e){return m.i1616to32(2*Math.round(8*h),2*Math.round(8*e))};B=function(h){function e(a,
d,c,b){var f=h.call(this,a,c.font.size,c.haloSize||0,c.color&&D.premultiplyAlphaRGBA(c.color)||0,c.haloColor&&D.premultiplyAlphaRGBA(c.haloColor)||0,c.horizontalAlignment,c.verticalAlignment,c.font.decoration,!1,c.angle||0,c.xoffset,c.yoffset,c.id,c.lineWidth,c.lineHeight)||this;f._outLineLabelAngle=0;f._refPlacementPadding=0;f._refPlacementDirX=0;f._refPlacementDirY=0;f._refOffsetX=0;f._refOffsetY=0;f.geometryType=L.WGLGeometryType.LABEL;var k;k=!!d.minScale&&b.scaleToZoom(d.minScale)||0;k=C.clamp(k,
0,25.5);b=!!d.maxScale&&b.scaleToZoom(d.maxScale)||255;b=C.clamp(b,0,25.5);var g=y.alignmentUtils.getAlignmentFromPlacement(d.labelPlacement),e=g[1];f._xAlignD=g[0];f._yAlignD=e;f._minZoom=k;f._maxZoom=b;f._refPlacementPadding=J.pt2px(c.haloSize)+K.TEXT_PLACEMENT_PADDING;a=w.LabelMaterialKey.load(w.createMaterialKey(f.geometryType,a,!1,d));a.sdf=!0;f._materialKey=a.data;return f}G(e,h);e.fromLabelClass=function(a,d,c){if("center-along"===d.labelPlacement){var b=d.symbol;b.xoffset=0;b.yoffset=0;b.angle=
0;b.font.decoration="none"}return new e(a,d,d.symbol,c)};Object.defineProperty(e.prototype,"_shapedBox",{get:function(){return p.unwrap(this._shapingInfo).bounds},enumerable:!0,configurable:!0});e.prototype.bindReferenceTemplate=function(a){var d=y.alignmentUtils.getXDirection(this._xAlignD),c=y.alignmentUtils.getYDirection(this._yAlignD);this._refOffsetY=this._refOffsetX=0;if(p.isNone(a))this._refSymbolAndPlacementOffset=m.i8888to32(0,0,Math.floor(127*d+127),Math.floor(127*c+127));else{if("circle"===
a.boundsType&&(d||c))var b=Math.sqrt(d*d+c*c),d=d/b,c=c/b;b=Math.max(a.height,a.width);this._refSymbolAndPlacementOffset=m.i8888to32(4*this._refPlacementPadding,b,Math.floor(127*d+127),Math.floor(127*c+127));this._referenceSize=b;this._refPlacementDirX=d;this._refPlacementDirY=c;this._refOffsetX=a.xOffset;this._refOffsetY=a.yOffset}};e.prototype.writeMesh=function(a,d,c,b,f,e,g){if(!p.isNone(this._shapingInfo))switch(this.current={outRecords:a,outVecs:d,outMetrics:g,inId:b,inShaping:this._shapingInfo,
zoomLevel:e},c){case "esriGeometryPolyline":return this._placeLineLabels(f.geometry);case "esriGeometryPoint":return this._placePointLabels(f.geometry);case "esriGeometryPolygon":return this._placePointLabels(f.centroid);default:a="Geometry of type "+c+" is not supported",void 0===a&&(a="mapview-labeling"),O.error(H(a,"mapview-labeling"))}};e.prototype._isVisible=function(a,d){var c=Math.floor(10*this.current.zoomLevel);return Math.floor(10*a)<=c&&c<=Math.floor(10*d)};e.prototype._placePointLabels=
function(a){var d=this.current;this._writeGlyphs(d.outRecords,d.outVecs,d.inId,a,d.outMetrics)};e.prototype._placeLineLabels=function(a){a=F.smoothPaths(a.paths,this.current.inShaping.bounds.width);for(var d=this._placeSubdivGlyphs.bind(this),c=(this._shapedBox.width+128)/4,b=0;b<a.length;b++)F.pathDivide(a[b],c,d)};e.prototype._placeSubdivGlyphs=function(a,d,c,b){var f=P(d);c=v.log2(Math.min(c,b-c)/(4+this._shapedBox.width/4/2));f=Math.max(this._minZoom,this.current.zoomLevel+2-(0===d?c:Math.min(f,
c)));c=this._shapedBox.width/2*Math.pow(2,this.current.zoomLevel-f);this.current.inShaping.isMultiline?0===d&&this._placeStraight(a,f):this._placeCurved(a,f,c)};e.prototype._placeStraight=function(a,d){var c=this.current;this._writeGlyphs(c.outRecords,c.outVecs,c.inId,a,c.outMetrics,d)};e.prototype._placeCurved=function(a,d,c){var b=new E.default(this.current.inId,{from:this.current.outRecords.length,count:-1},a.x,a.y,d),f=a.clone(),e=(180/Math.PI*a.angle+180)%360;this._outLineLabelAngle=Math.round(180/
Math.PI*a.angle%360*(254/360));this._placeFirst(f,b,d,1);this._placeBack(a,f,b,d,c,1);this._placeForward(a,f,b,d,c,1);this._outLineLabelAngle=Math.round(254/360*e);this._placeFirst(f,b,d,0);this._placeBack(a,f,b,d,c,0);this._placeForward(a,f,b,d,c,0);b.range.count=this.current.outRecords.length-b.range.from;b.bounds&&this.current.outMetrics.push(b)};e.prototype._placeBack=function(a,d,c,b,f,e){var g=a.clone();for(a=a.backwardLength+0;g.prev()&&!(a>=f);)this._placeOnSegment(g,d,c,a,b,-1,e),a+=g.length+
0};e.prototype._placeForward=function(a,d,c,b,f,e){var g=a.clone();for(a=a.remainingLength+0;g.next()&&!(a>=f);)this._placeOnSegment(g,d,c,a,b,1,e),a+=g.length+0};e.prototype._placeFirst=function(a,d,c,b){for(var f=this.current.inShaping,e=f.glyphs,g=this.current.zoomLevel,h=this.current,Q=h.outRecords,A=h.outVecs,h=h.inId,r=z(a.x,a.y),t=0;t<e.length;t++){var l=e[t],q=l.x>f.bounds.x?b:1-b,q=Math.max(0,g+v.log2(Math.abs(l.x+l.width/2-f.bounds.x)/(q*a.remainingLength+(1-q)*a.backwardLength+0))),q=Math.max(c,
q);l.maxZoom=25;l.angle=a.angle+(1-b)*Math.PI;l.minZoom=q;this._writeGlyph(Q,A,l,h,r);b&&this._isVisible(l.minZoom,l.maxZoom)&&d.add(l.bounds,0,0)}};e.prototype._placeOnSegment=function(a,d,c,b,f,e,g){for(var h=this.current.inShaping.glyphs,k=this.current,A=k.outRecords,r=k.outVecs,k=k.inId,t=this.current.inShaping,l=this.current.zoomLevel,q=z(a.x+a.dx/a.length*-e*b,a.y+a.dy/a.length*-e*b),m=0;m<h.length;m++){var n=h[m],u=n.x>t.bounds.x?g:1-g;if(u&&1===e||!u&&-1===e){var p=Math.abs(n.x+n.width/2-
t.bounds.x),u=Math.max(0,l+v.log2(p/b)-.1),p=Math.max(f,l+v.log2(p/(b+a.length+0)));0!==u&&(n.angle=a.angle+(1-g)*Math.PI,n.minZoom=p,n.maxZoom=u,this._writeGlyph(A,r,n,k,q),g&&this._isVisible(n.minZoom,n.maxZoom)&&c.add(n.bounds,a.x-d.x,a.y-d.y))}}};e.prototype._writeGlyphs=function(a,d,c,b,f,e){void 0===e&&(e=this._minZoom);var g=this._shapingInfo;if(!(p.isNone(g)||0>b.x||512<=b.x||0>b.y||512<=b.y)){var h=z(b.x+this._refOffsetX,b.y-this._refOffsetY);b=new E.default(c,{from:a.length,count:-1},b.x+
this._refOffsetX,b.y-this._refOffsetY,e);for(var k=0,m=g.glyphs;k<m.length;k++){var r=m[k];r.minZoom=e;r.maxZoom=this._maxZoom;this._writeGlyph(a,d,r,c,h)}b.range.count=a.length-b.range.from;b.bounds=g.boundsT;a=w.LabelMaterialKey.load(this._materialKey);b.setPlacementOffset(a.vvSizeFieldStops||a.vvSizeMinMaxValue||a.vvSizeScaleStops||a.vvSizeUnitValue,this._referenceSize,this._refPlacementPadding,this._refPlacementDirX,this._refPlacementDirY);f.push(b)}};e.prototype._writeGlyph=function(a,d,c,b,
e){var f=w.MaterialKeyBase.load(this._materialKey),g=new M(b,this.geometryType,f.data,0,0);f.textureBinding=c.textureBinding;g.materialKey=f.data;g.indexFrom=d.indexVector.length;g.indexCount=this._writeIndices(d);g.vertexFrom=d.getVector("geometry").vertexCount;g.vertexCount=this._writeVertex(d,b,e,c);a.push(g)};e.prototype._writeVertexCommon=function(a,d,c,b){var e=this._color,h=this._haloColor,g=m.i8888to32(0,0,this._size,this._haloSize);b=m.i8888to32(Math.floor(10*Math.max(b.minZoom,this._minZoom)),
Math.floor(10*Math.min(b.maxZoom,this._maxZoom)),this._outLineLabelAngle,0);a.push(c);a.push(d);a.push(e);a.push(h);a.push(g);a.push(this._refSymbolAndPlacementOffset);a.push(b)};return e}(N.default);x.default=B});