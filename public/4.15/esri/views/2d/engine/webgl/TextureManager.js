// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/generatorHelper ../../../../config ../../../../request ../../../../core/Error ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f32 ../../../../symbols/cim/Rasterizer ./definitions ./enums ./fontUtils ./GlyphMosaic ./GlyphSource ./SDFConverter ./SpriteMosaic ./animatedFormats/apng ./animatedFormats/gif ./util/BidiText ./util/Result ./util/symbolUtils".split(" "),
function(W,X,C,k,m,G,x,p,H,I,y,D,E,J,K,r,t,L,M,N,O,P,z,A,Q,B,R){function S(b){switch(b.type){case "CIMSolidStroke":case "CIMSolidFill":return!0;case "esriSFS":return"esriSFSSolid"===b.style||"esriSFSNull"===b.style;case "esriSLS":return"esriSLSSolid"===b.style||"esriSLSNull"===b.style;default:return!1}}function w(b){switch(b.type){case "esriSMS":case "esriPMS":case "CIMPointSymbol":case "CIMVectorMarker":case "CIMPictureMarker":case "CIMCharacterMarker":return!1;default:return!0}}function T(b){return k(this,
void 0,void 0,function(){var a,d;return m(this,function(e){switch(e.label){case 0:a=window.URL.createObjectURL(b),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,x(a,{responseType:"image"})];case 2:return d=e.sent().data,window.URL.revokeObjectURL(a),[2,d];case 3:return e.sent(),window.URL.revokeObjectURL(a),[2,new p("mapview-invalid-resource","Could not fetch requested resource at "+a)];case 4:return[2]}})})}function U(b,a){return k(this,void 0,void 0,function(){var d,e,c,f,g,h,l,u,n;return m(this,
function(q){switch(q.label){case 0:d=b.imageData?"data:"+b.contentType+";base64,"+b.imageData:b.url;if(-1===d.indexOf(";base64,"))return[3,1];c=d.indexOf(";base64,")+8;f=d.substring(c);g=atob(f);h=new Uint8Array(g.length);for(l=0;l<g.length;l++)h[l]=g.charCodeAt(l);e=h.buffer;return[3,4];case 1:return q.trys.push([1,3,,4]),[4,x(d,C({responseType:"array-buffer"},a))];case 2:return e=u=q.sent().data,[3,4];case 3:return n=q.sent(),y.isAbortError(n)?[3,4]:[2,new p("mapview-invalid-resource","Could not fetch requested resource at "+
d)];case 4:return[2,e]}})})}var F=J.vec2f32.create(),v=H.getLogger("esri.views.2d.engine.webgl.TextureManager"),V=function(){function b(a,d,e){this.mosaicType=a;this.page=d;this.sdf=e}b.fromMosaic=function(a,d){return new b(a,d.page,d.sdf)};return b}();return function(){function b(a){this._invalidFontsMap=new Map;this._sdfConverter=new O.default(126);this._bindingInfos=[];this._hashToBindingIndex=new Map;this._rasterizer=new K.default;this._spriteMosaic=new P(a,2048,2048,500);this._glyphSource=new N(G.fontsUrl+
"/{fontstack}/{range}.pbf");this._glyphMosaic=new M(1024,1024,this._glyphSource)}b.prototype.dispose=function(){this._spriteMosaic.dispose();this._glyphMosaic.dispose();this._rasterizer.dispose();this._rasterizer=this._glyphMosaic=this._spriteMosaic=null};Object.defineProperty(b.prototype,"sprites",{get:function(){return this._spriteMosaic},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"glyphs",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});b.prototype.rasterizeItem=
function(a,d,e){return k(this,void 0,void 0,function(){var c,b,g,h=this;return m(this,function(f){switch(f.label){case 0:if(I.isNone(a))return v.error(new p("mapview-null-resource","Unable to rasterize null resource",void 0)),[2,null];c=a.type;switch(c){case "CIMTextSymbol":return[3,1];case "esriTS":return[3,1]}return[3,3];case 1:return[4,this._rasterizeText(a,d,e)];case 2:return b=f.sent(),b.forEach(function(a){return h._setTextureBinding(t.MosaicType.GLYPH,a)}),[2,{glyphMosaicItems:b}];case 3:return a.type&&
-1!==a.type.toLowerCase().indexOf("3d")?(v.error(new p("mapview-invalid-type","MapView does not support symbol type: "+a.type,a)),[2,null]):[4,this._rasterizeSpriteSymbol(a,e)];case 4:return g=f.sent(),B.ok(g)&&g&&this._setTextureBinding(t.MosaicType.SPRITE,g),[2,{spriteMosaicItem:g}]}})})};b.prototype.bindTextures=function(a,d,e){if(0!==e.textureBinding){var c=this._bindingInfos[e.textureBinding-1];e=c.page;switch(c.mosaicType){case t.MosaicType.SPRITE:var c=this.sprites.getWidth(e),b=this.sprites.getHeight(e),
c=E.vec2.set(F,c,b);this._spriteMosaic.bind(a,9729,e,r.TEXTURE_BINDING_SPRITE_ATLAS);d.setUniform1i("u_texture",r.TEXTURE_BINDING_SPRITE_ATLAS);d.setUniform2fv("u_mosaicSize",c);break;case t.MosaicType.GLYPH:c=this.glyphs.width;b=this.glyphs.height;c=E.vec2.set(F,c,b);this._glyphMosaic.bind(a,9729,e,r.TEXTURE_BINDING_GLYPH_ATLAS);d.setUniform1i("u_texture",r.TEXTURE_BINDING_GLYPH_ATLAS);d.setUniform2fv("u_mosaicSize",c);break;default:v.error("mapview-texture-manager","Cannot handle unknown type "+
c.mosaicType)}}};b.prototype._hashMosaic=function(a,d){return 1|a<<1|(d.sdf?1:0)<<2|d.page<<3};b.prototype._setTextureBinding=function(a,d){var e=this._hashMosaic(a,d);this._hashToBindingIndex.has(e)||(a=V.fromMosaic(a,d),this._hashToBindingIndex.set(e,this._bindingInfos.length+1),this._bindingInfos.push(a));d.textureBinding=this._hashToBindingIndex.get(e)};b.prototype._rasterizeText=function(a,d,e){return k(this,void 0,void 0,function(){var c,b,g;return m(this,function(h){switch(h.label){case 0:c=
L.getFullyQualifiedFontName(a.font);b=this._invalidFontsMap.has(c);var f;if(d)f=d;else{f=Q.bidiText(a.text)[0];for(var u=[],n=0;n<f.length;n++)u.push(f.charCodeAt(n));f=u}g=f;h.label=1;case 1:return h.trys.push([1,3,,4]),[4,this._glyphMosaic.getGlyphItems(b?"arial-unicode-ms-regular":c,g,e)];case 2:return[2,h.sent()];case 3:return h.sent(),v.error(new p("mapview-invalid-resource","Couldn't find font "+c+". Falling back to Arial Unicode MS Regular",void 0)),this._invalidFontsMap.set(c,!0),[2,this._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",
g,e)];case 4:return[2]}})})};b.prototype._rasterizeSpriteSymbol=function(a,b){return k(this,void 0,void 0,function(){var e,c,d,g,h,l;return m(this,function(f){if(S(a))return[2,null];e=R.keyFromSymbol(a);return this._spriteMosaic.has(e)?[2,this._spriteMosaic.getSpriteItem(e)]:"esriSMS"===a.type&&a.path?[2,this._handleSVG(a,e,b)]:a.url||a.imageData?[2,this._handleImage(a,e,b)]:(c=this._rasterizer.rasterizeJSONResource(a))?(d=c.size,g=c.image,h=c.sdf,l=c.simplePattern,[2,this._addItemToMosaic(e,d,{type:"static",
data:g},w(a),h,l)]):[2,new p("TextureManager","unrecognized or null rasterized image")]})})};b.prototype._handleSVG=function(a,b,e){return k(this,void 0,void 0,function(){var c,d;return m(this,function(g){switch(g.label){case 0:return c=[126,126],[4,this._sdfConverter.draw(a.path,e)];case 1:return d=g.sent(),[2,this._addItemToMosaic(b,c,{type:"static",data:new Uint32Array(d.buffer)},!1,!0,!0)]}})})};b.prototype._handleGIFOrPNG=function(a,b,e){return k(this,void 0,void 0,function(){var c,d,g,h,l,u,
n,q,k,r,t,v;return m(this,function(f){switch(f.label){case 0:return[4,U(a,e)];case 1:c=f.sent();if(!B.ok(c))return[3,10];d=A.isGIF(c);g=z.isPNG(c);if(!d&&!g)return[2,new p("mapview-invalid-resource","Image data is neither GIF nor PNG!")];h=void 0;f.label=2;case 2:return f.trys.push([2,7,,8]),d&&A.isAnimatedGIF(c)?[4,A.default.create(c,e)]:[3,4];case 3:return h=f.sent(),[3,6];case 4:return g&&z.isAnimatedPNG(c)?[4,z.default.create(c,e)]:[3,6];case 5:h=f.sent(),f.label=6;case 6:return[3,8];case 7:return l=
f.sent(),y.isAbortError(l)?[3,8]:[2,new p("mapview-invalid-resource","Could not fetch requested resource!")];case 8:if(h&&B.ok(h))return[2,this._addItemToMosaic(b,[h.width,h.height],{type:"animated",data:h},w(a),!1,!1)];u=d?"image/gif":"image/png";n=new Blob([c],{type:u});return[4,T(n)];case 9:if((q=f.sent())&&q instanceof HTMLImageElement)return k=this._rasterizer.rasterizeImageResource(q,a.colorSubstitutions),r=k.size,t=k.sdf,v=k.image,[2,this._addItemToMosaic(b,r,{type:"static",data:v},w(a),t,
!1)];f.label=10;case 10:return[2,new p("mapview-invalid-resource","Could not handle resource!")]}})})};b.prototype._handleImage=function(a,b,e){return k(this,void 0,void 0,function(){var c,d,g,h,l,k,n;return m(this,function(f){switch(f.label){case 0:var m;(m=a.url&&-1!==a.url.indexOf(".gif")||a.contentType&&"image/gif"===a.contentType||a.imageData&&-1!==a.imageData.indexOf("data:image/gif"))||(m=a.url&&-1!==a.url.indexOf(".png")||a.contentType&&"image/png"===a.contentType||a.imageData&&-1!==a.imageData.indexOf("data:image/png"));
if(m)return[2,this._handleGIFOrPNG(a,b,e)];c=a.imageData?"data:"+a.contentType+";base64,"+a.imageData:a.url;f.label=1;case 1:return f.trys.push([1,3,,4]),[4,x(c,C({responseType:"image"},e))];case 2:return d=f.sent().data,-1!==c.indexOf("data:image/svg+xml")&&(d.width=D.pt2px(a.width),d.height=D.pt2px(a.height)),g=this._rasterizer.rasterizeImageResource(d,a.colorSubstitutions),h=g.size,l=g.sdf,k=g.image,[2,this._addItemToMosaic(b,h,{type:"static",data:k},w(a),l,!1)];case 3:return n=f.sent(),y.isAbortError(n)?
[3,4]:[2,new p("mapview-invalid-resource","Could not fetch requested resource at "+c)];case 4:return[2,void 0]}})})};b.prototype._addItemToMosaic=function(a,b,e,c,f,g){return this._spriteMosaic.addSpriteItem(a,b,e,c,f,g)};return b}()});