// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../core/tsSupport/assignHelper ../../core/Error ../../core/maybe ../../core/promiseUtils ../../core/accessorSupport/decorators ../../renderers/support/clickToleranceUtils ../../support/arcadeOnDemand ./support/popupUtils".split(" "),function(C,c,x,e,q,h,y,z,t,f,b,A,B,u){Object.defineProperty(c,"__esModule",{value:!0});c.MapImageLayerView=
function(c){return function(c){function d(){return null!==c&&c.apply(this,arguments)||this}x(d,c);d.prototype.fetchPopupFeatures=function(c,d){return h(this,void 0,void 0,function(){var b,g,k,l,e,n,v,w=this;return q(this,function(m){switch(m.label){case 0:b=this.layer;if(!c)return[2,f.reject(new z("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:b}))];g=this.get("view.scale");k=[];l=function(a){return h(w,void 0,void 0,function(){var c,b,r;return q(this,function(D){c=
0===a.minScale||g<=a.minScale;b=0===a.maxScale||g>=a.maxScale;a.visible&&c&&b&&(a.sublayers?a.sublayers.forEach(l):a.popupEnabled&&(r=u.getFetchPopupTemplate(a,y({},d,{defaultPopupTemplateEnabled:!1})),t.isSome(r)&&k.push({sublayer:a,popupTemplate:r})));return[2]})})};e=b.sublayers.toArray().map(l);return[4,f.all(e)];case 1:return m.sent(),n=k.map(function(a){var b=a.sublayer,e=a.popupTemplate;return h(w,void 0,void 0,function(){var a,h,f,g,k,l,m,n;return q(this,function(p){switch(p.label){case 0:return[4,
b.load().catch(function(){})];case 1:return p.sent(),a=b.createQuery(),h=t.isSome(d)?d.event:null,f=A.calculateTolerance({renderer:b.renderer,event:h}),g=this.createFetchPopupFeaturesQueryGeometry(c,f),a.geometry=g,k=a,[4,u.getRequiredFields(b,e)];case 2:return k.outFields=p.sent(),[4,this._loadArcadeModules(e)];case 3:return m=(l=p.sent())&&l.arcadeUtils.hasGeometryOperations(e),m||(a.maxAllowableOffset=g.width/f),[4,b.queryFeatures(a)];case 4:return n=p.sent(),[2,n.features]}})})}),[4,f.eachAlways(n)];
case 2:return v=m.sent(),[2,v.reduce(function(a,b){return a.concat(b.value)},[]).filter(function(a){return null!=a})]}})})};d.prototype._loadArcadeModules=function(b){if(b.get("expressionInfos.length"))return B.loadArcade()};e([b.property()],d.prototype,"layer",void 0);return d=e([b.subclass("esri.views.layers.MapImageLayerView")],d)}(b.declared(c))}});