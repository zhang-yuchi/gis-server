// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/assignHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../Color ../request ../core/Error ../core/lang ../core/Logger ../core/LRUCache ../core/maybe ../core/promiseUtils ../core/SetUtils ../core/accessorSupport/decorators ../layers/support/fieldUtils ./Renderer ./mixins/VisualVariablesMixin ../support/arcadeOnDemand ../symbols/CIMSymbol".split(" "),function(W,X,
L,h,v,n,l,M,C,N,e,O,P,r,D,Q,f,R,S,T,I,U){var V=O.getLogger("esri.renderers.DictionaryRenderer");return function(J){function b(a){a=J.call(this,a)||this;a._ongoingRequests=new Map;a._symbolCache=new P(100);a.config=null;a.description=null;a.fieldMap=null;a.label=null;a.scaleExpression=null;a.url=null;a.type="dictionary";return a}L(b,J);q=b;b.prototype.clone=function(){return new q({config:e.clone(this.config),scaleExpression:e.clone(this.scaleExpression),description:e.clone(this.description),fieldMap:e.clone(this.fieldMap),
label:e.clone(this.label),url:e.clone(this.url),visualVariables:e.clone(this.visualVariables)})};b.prototype.getSymbolAsync=function(a,b){return l(this,void 0,void 0,function(){var A,d,c,w,g,p,k,f,E,h,x,e,t,z,m,u,K,F,y,B,G,l,v,r,q,H,C=this;return n(this,function(n){switch(n.label){case 0:this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(b)),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this._dictionaryPromise];case 2:return A=n.sent(),[3,4];case 3:return d=n.sent(),D.isAbortError(d)?
(this._dictionaryPromise=null,[2,null]):[3,4];case 4:c={};w=0;for(g=this._symbolAttributes;w<g.length;w++)p=g[w],(k=this.fieldMap[p])&&null!==a.attributes[k]&&void 0!==a.attributes[k]?(f=""+a.attributes[k],c[p]=f):c[p]="";E=A(c,b);if(!E||"string"!==typeof E)return[2,null];h=E.split(";");x=[];e=[];t=0;for(z=h;t<z.length;t++)if((m=z[t])&&0!==m.length)if(-1!==m.indexOf("po:"))u=m.substr(3).split("|"),3===u.length&&(K=u[0],F=u[1],y=u[2],"DashTemplate"===F?y=y.split(" ").map(function(a){return Number(a)}):
"Color"===F?(B=(new M(y)).toRgba(),y=[B[0],B[1],B[2],255*B[3]]):y=Number(y),e.push({primitiveName:K,propertyName:F,value:y}));else if(-1!==m.indexOf("|"))for(G=0,l=m.split("|");G<l.length;G++)v=l[G],this._itemNames.has(v)&&x.push(v);else this._itemNames.has(m)&&x.push(m);r=x.join(";")+e.map(function(a){return a.primitiveName+";"+a.propertyName+";"+a.value});if(q=this._symbolCache.get(r))return q.catch(function(){C._symbolCache.pop(r)}),[2,q];H=this._cimPartsToCIMSymbol(x,e,b);this._symbolCache.put(r,
H,1);return[2,H]}})})};b.prototype.collectRequiredFields=function(a,b){return l(this,void 0,void 0,function(){var p,d;return n(this,function(c){switch(c.label){case 0:return[4,this.collectVVRequiredFields(a,b)];case 1:return c.sent(),this.scaleExpression?[4,R.collectArcadeFieldNames(a,b,this.scaleExpression)]:[3,3];case 2:c.sent(),c.label=3;case 3:p=b.map(function(a){return a.name});for(d in this.fieldMap)0>p.indexOf(this.fieldMap[d])||a.add(this.fieldMap[d]);return[2]}})})};Object.defineProperty(b.prototype,
"arcadeRequired",{get:function(){return!0},enumerable:!0,configurable:!0});b.prototype.fetchResources=function(a){return l(this,void 0,void 0,function(){var b,A,d,c,w,g,e,k,f,h,l,x,q,t,z,m,u;return n(this,function(p){switch(p.label){case 0:if(!this.url)return V.error("no valid URL!"),[2,void 0];b=r.isSome(a)?a.abortOptions:null;A=C(this.url+"/resources/styles/dictionary-info.json",v({responseType:"json",query:{f:"json"}},b));return[4,D.all([A,I.loadArcade()])];case 1:d=p.sent()[0].data;if(!d)throw new N("esri.renderers.DictionaryRenderer",
"Bad dictionary data!");c=d.expression;w=d.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+d.cimRefTemplateUrl;this._itemNames=Q.createSetFromValues(d.itemsNames);this._symbolAttributes=w.symbol;g={};if(this.config)for(k in e=this.config,e)g[k]=e[k];f=0;for(h=w.configuration;f<h.length;f++)k=h[f],g.hasOwnProperty(k.name)||(g[k.name]=k.value);l=[];if(r.isSome(a)&&a.fields)for(x=function(b){var d=q.fieldMap[b],c=a.fields.filter(function(a){return a.name===d});0<c.length&&l.push(v({},c[0],{name:b}))},
q=this,t=0,z=this._symbolAttributes;t<z.length;t++)k=z[t],x(k);return[4,I.createDictionaryExpression(c,r.isSome(a)?a.spatialReference:null,l,g)];case 2:return m=p.sent(),u={scale:0},[2,function(a,b){a=m.repurposeFeature({geometry:null,attributes:a});u.scale=r.isSome(b)?b.scale:void 0;return m.evaluate({$feature:a,$view:u})}]}})})};b.prototype.getSymbol=function(){return null};b.prototype.getSymbols=function(){return[]};b.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(function(a,
b){return a+b.getAttributeHash()},"")};b.prototype.getMeshHash=function(){return this.url+"-"+JSON.stringify(this.fieldMap)};b.prototype._getSymbolPart=function(a,b){return l(this,void 0,void 0,function(){var e,d,c,f;return n(this,function(g){switch(g.label){case 0:if(this._ongoingRequests.has(a))return[2,this._ongoingRequests.get(a).then(function(a){return a.data})];e=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,a);d=C(e,v({responseType:"json",query:{f:"json"}},b));this._ongoingRequests.set(a,
d);g.label=1;case 1:return g.trys.push([1,3,,4]),[4,d];case 2:return c=g.sent(),[2,c.data];case 3:return f=g.sent(),this._ongoingRequests.delete(a),[2,D.reject(f)];case 4:return[2]}})})};b.prototype._combineSymbolParts=function(a,b){var e;if(!a||0===a.length)return null;if(1===a.length)return{type:"CIMSymbolReference",symbol:a[0],primitiveOverrides:b};var d=v({},a[0]);d.symbolLayers=[];for(var c=0;c<a.length;c++){var f=a[c];(e=d.symbolLayers).unshift.apply(e,f.symbolLayers)}return{type:"CIMSymbolReference",
symbol:d,primitiveOverrides:b}};b.prototype._cimPartsToCIMSymbol=function(a,b,e){return l(this,void 0,void 0,function(){var d,c,f;return n(this,function(g){switch(g.label){case 0:d=Array(a.length);for(c=0;c<a.length;c++)d[c]=this._getSymbolPart(a[c],e);return[4,D.all(d)];case 1:return f=g.sent(),[2,new U({data:this._combineSymbolParts(f,b)})]}})})};var q;h([f.property({type:Object,json:{write:!0}})],b.prototype,"config",void 0);h([f.property({type:String,json:{write:!0}})],b.prototype,"description",
void 0);h([f.property({type:Object,json:{write:!0}})],b.prototype,"fieldMap",void 0);h([f.property({type:String,json:{write:!0}})],b.prototype,"label",void 0);h([f.property({type:String,json:{write:!0}})],b.prototype,"scaleExpression",void 0);h([f.property({type:String,json:{write:!0}})],b.prototype,"url",void 0);return b=q=h([f.subclass("esri.renderers.DictionaryRenderer")],b)}(f.declared(T.VisualVariablesMixin(S)))});