// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/assignHelper ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../rasterRenderers ../../core/JSONSupport ../../core/Logger ../../core/accessorSupport/decorators ../../layers/support/RasterInfo ../../layers/support/rasterFunctions/pixelUtils ../support/colorRampUtils".split(" "),function(D,E,t,y,r,F,G,u,z,A,m,B,g,C){var v=A.getLogger("esri.renderers.support.RasterSymbolizer");
return function(w){function e(a){return w.call(this,a)||this}y(e,w);e.prototype.readRenderer=function(a,c,b){return u.read(a,b)};e.prototype.bind=function(){this.lookup={};if(!this.renderer)return!1;var a;switch(this.renderer.type){case "unique-value":a=this._updateUVRenderer(this.renderer);break;case "raster-colormap":a=this._updateColormapRenderer(this.renderer);break;case "raster-stretch":a=this._updateStretchRenderer(this.renderer);break;case "class-breaks":a=this._updateClassBreaksRenderer(this.renderer)}return a};
e.prototype.symbolize=function(a){if(!this.isValidPixelBlock(a))return a;try{3<a.pixels.length&&(a=g.extractBands(a,[0,1,2]));var c=void 0;switch(this.renderer.type){case "unique-value":case "raster-colormap":c=this._symbolize_colormap(a);break;case "class-breaks":c=this._symbolize_classBreaks(a);break;case "raster-stretch":c=this._symbolize_stretch(a)}return c}catch(b){return v.error("symbolize",b.message),a}};e.prototype.simpleStretch=function(a,c){if(!this.isValidPixelBlock(a))return a;try{return 3<
a.pixels.length&&(a=g.extractBands(a,[0,1,2])),g.stretch(a,c)}catch(b){return v.error("symbolize",b.message),a}};e.prototype.generateWebGLParameters=function(a){if(-1<["unique-value","raster-colormap","class-breaks"].indexOf(this.renderer.type)){var c=this.lookup.lut;return{colormap:c.indexedColormap,colormapOffset:c.colormapOffset,type:"lut"}}var b=this.renderer,x=c=null,d=this.lookup&&this.lookup.colorRampLut;b.colorRamp&&d&&(c=d.indexedColormap,x=d.offset);var d=b.gamma,f=b.useGamma,e=this.getStretchCutoff(b,
a),b=e.minCutOff,n=e.maxCutOff,q=e.outMin,e=e.outMax;a&&a.pixels&&2===a.pixels.length&&(a=a.clone(),a.statistics=[a.statistics[0]],a.pixels=[a.pixels[0]]);a=Math.min(3,a&&a.getPlaneCount()||this.rasterInfo.bandCount);var p=new Float32Array(a),g=null==c?255:1,h;for(h=0;h<a;h++)p[h]=(e-q)/(n[h]-b[h])/g;var k=new Float32Array(a);if(f)for(h=0;h<a;h++)k[h]=1<d[h]?2<d[h]?6.5+Math.pow(d[h]-2,2.5):6.5+100*Math.pow(2-d[h],4):1;return{bandCount:a,outMin:q/g,outMax:e/g,minCutOff:b,maxCutOff:n,factor:p,useGamma:f,
gamma:f?d:[1,1,1],gammaCorrection:f?k:[1,1,1],colormap:c,colormapOffset:x,type:"stretch"}};e.prototype._isLUTChanged=function(a){if(!this.lookup)return!0;if("raster-stretch"===this.renderer.type){var c=this.renderer.colorRamp;if(a)return JSON.stringify(c.toJSON())!==JSON.stringify(this.lookup.rendererJson.colorRamp);a=t({},this.renderer.toJSON());c=t({},this.lookup.rendererJson);a.colorRamp=null;c.colorRamp=null}return JSON.stringify(this.renderer.toJSON())!==JSON.stringify(this.lookup.rendererJson)};
e.prototype._symbolize_colormap=function(a){return this._isLUTChanged()&&!this.bind()?a:g.colorize(a,this.lookup.lut)};e.prototype._symbolize_classBreaks=function(a){var c=-1<["u8","u16","s8","s16"].indexOf(this.rasterInfo.pixelType);return this._isLUTChanged()&&!this.bind()?a:c?g.colorize(a,this.lookup.lut):g.remapColor(a,this.lookup.lut)};e.prototype._symbolize_stretch=function(a){var c=this.rasterInfo.pixelType,b=this.renderer,e=-1<["u8","u16","s8","s16"].indexOf(c),d=b.gamma,f=b.useGamma;if(e){if(b.dynamicRangeAdjustment)e=
this.getStretchCutoff(b,a),c=g.createStretchLUT(t({pixelType:c},e,{gamma:f?d:null}));else{if(this._isLUTChanged()&&(d=this.bind(),!d))return a;c=this.lookup?this.lookup.lut:null}if(!c)return a;c=g.lookupPixels(a,c)}else e=this.getStretchCutoff(b,a),c=g.stretch(a,t({},e,{gamma:f?d:null}));if(b.colorRamp){if(this._isLUTChanged(!0)&&(d=this.bind(),!d))return a;c=g.colorize(c,this.lookup.colorRampLut)}return c};e.prototype._updateUVRenderer=function(a){var c=this.rasterInfo,b=c.bandCount,e=c.attributeTable,
d=c.statistics,c=-1<["u8","s8"].indexOf(c.pixelType)&&d&&null!=d[0].min&&null!=d[0].max;if(1!==b||!e&&!c)return!1;var f=a.field;if(!f)return!1;var l=[];if(e){var n=e.fields.filter(function(a){return"value"===a.name.toLowerCase()})[0];if(!n)return!1;e.features.forEach(function(b){var c=a.uniqueValueInfos.filter(function(a){return String(a.value)===String(b.attributes[f])})[0];(c=c&&c.symbol&&c.symbol.color)&&l.push([b.attributes[n.name],c.r,c.g,c.b,1<c.a?c.a:Math.round(255*c.a)])})}else{if("Value"!==
f.toLowerCase())return!1;a.uniqueValueInfos.forEach(function(a){var b=a&&a.symbol&&a.symbol.color;b&&l.push([parseInt(a.value,10),b.r,b.g,b.b,1<b.a?b.a:Math.round(255*b.a)])})}if(0===l.length)return!1;b=g.createColormapLUT({colormap:l});this.lookup={rendererJson:a.toJSON(),lut:b};return this.canRenderInWebGL=!0};e.prototype._updateColormapRenderer=function(a){var c=a.extractColormap();if(!c||0===c.length)return!1;c=g.createColormapLUT({colormap:c});this.lookup={rendererJson:a.toJSON(),lut:c};return this.canRenderInWebGL=
!0};e.prototype._updateClassBreaksRenderer=function(a){var c=-1<["u8","u16","s8","s16"].indexOf(this.rasterInfo.pixelType),b=a.classBreakInfos;if(!b||0===b.length)return!1;var e=b.sort(function(a,b){return a.minValue-b.minValue}),b=e[e.length-1];if(!c)return c=e.map(function(a){return{value:a.minValue,mappedColor:[a.symbol.color.r,a.symbol.color.g,a.symbol.color.b,1<a.symbol.color.a?a.symbol.color.a:Math.round(255*a.symbol.color.a)]}}),c.push({value:b.maxValue,mappedColor:[b.symbol.color.g,b.symbol.color.b,
1<b.symbol.color.a?b.symbol.color.a:Math.round(255*b.symbol.color.a)]}),this.lookup={rendererJson:a.toJSON(),lut:c},this.canRenderInWebGL=!1,!0;var d=[],f,l=0;e.forEach(function(a){f=Math.ceil(a.minValue);l=Math.floor(a.maxValue);for(var b=f;b<l;b++)d.push([b,a.symbol.color.r,a.symbol.color.g,a.symbol.color.b,1<a.symbol.color.a?a.symbol.color.a:Math.round(255*a.symbol.color.a)])});d.push([b.maxValue,b.symbol.color.r,b.symbol.color.g,b.symbol.color.b,1<b.symbol.color.a?b.symbol.color.a:Math.round(255*
b.symbol.color.a)]);c=g.createColormapLUT({colormap:d,fillUnspecified:!1});this.lookup={rendererJson:a.toJSON(),lut:c};return this.canRenderInWebGL=!0};e.prototype._updateStretchRenderer=function(a){if(!(a.statistics||this.rasterInfo.statistics||a.dynamicRangeAdjustment))return!1;var c=a.histograms||this.rasterInfo.histograms;if(!a.dynamicRangeAdjustment&&"percent-clip"===a.stretchType&&!c)return!1;var b=a.gamma,e=a.useGamma,c=a.colorRamp,d=this.rasterInfo.pixelType;if(!a.dynamicRangeAdjustment&&
-1<["u8","u16","s8","s16"].indexOf(d)){var f=this.getStretchCutoff(a),b=g.createStretchLUT(t({pixelType:d},f,{gamma:e?b:null}));this.lookup={rendererJson:a.toJSON(),lut:b}}c&&(c=C.convertColorRampToColormap(c,256),this.lookup.colorRampLut=g.createColormapLUT({colormap:c}),this.lookup.rendererJson=a.toJSON());return this.canRenderInWebGL=!0};e.prototype.getStretchCutoff=function(a,c){var b,e,d=a.stretchType;a.dynamicRangeAdjustment?"min-max"===d&&c.statistics?b=c.statistics.map(function(a){return[a.minValue,
a.maxValue,0,0]}):(e=g.estimateStatisticsHistograms(c),b=e.statistics,e=e.histograms):(b=a.statistics&&0<a.statistics.length?a.statistics:this.rasterInfo.statistics,e=a.histograms||this.rasterInfo.histograms);c=b||e?(b||e).length:this.rasterInfo.bandCount;var f=[],l=[],n,q,p,m,h,k;b[0]instanceof Array||(b=b.map(function(a){return[a.min,a.max,a.avg,a.stddev]}));switch(d){case "min-max":for(d=0;d<c;d++)f[d]=b[d][0],l[d]=b[d][1];break;case "standard-deviation":for(d=0;d<c;d++)f[d]=b[d][2]-a.numberOfStandardDeviations*
b[d][3],l[d]=b[d][2]+a.numberOfStandardDeviations*b[d][3],f[d]<b[d][0]&&(f[d]=b[d][0]),l[d]>b[d][1]&&(l[d]=b[d][1]);break;case "percent-clip":for(d=0;d<c;d++){b=e[d];m=new Uint32Array(b.size);p=b.counts;q=0;n=(b.max-b.min)/b.size;h=-.5===b.min&&1===n?.5:0;for(k=0;k<b.size;k++)q+=p[k],m[k]=q;p=a.minPercent*q/100;for(k=0;k<b.size;k++)if(m[k]>p){f[d]=b.min+n*(k+h);break}p=(1-a.maxPercent/100)*q;for(k=b.size-2;0<=k;k--)if(m[k]<p){l[d]=b.min+n*(k+2-h);break}}break;default:for(d=0;d<c;d++)f[d]=b[d][0],
l[d]=b[d][1]}return{minCutOff:f,maxCutOff:l,outMax:a.outputMax||255,outMin:a.outputMin||0}};e.prototype.isValidPixelBlock=function(a){return!!(a&&a.pixels&&0<a.pixels.length&&0!==a.validPixelCount)};r([m.property({types:u.rasterRendererTypes,json:{write:!0}})],e.prototype,"renderer",void 0);r([m.reader("renderer")],e.prototype,"readRenderer",null);r([m.property({type:B,json:{write:!0}})],e.prototype,"rasterInfo",void 0);r([m.property({json:{write:!0}})],e.prototype,"lookup",void 0);r([m.property({})],
e.prototype,"canRenderInWebGL",void 0);return e=r([m.subclass("esri.renderers.support.RasterSymbolizer")],e)}(m.declared(z.JSONSupport))});