// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../Basemap ../Viewpoint ../core/asyncUtils ../core/Collection ../core/collectionUtils ../core/JSONSupport ../core/Logger ../core/promiseUtils ../core/accessorSupport/decorators ../core/accessorSupport/ensureType ../core/libs/gl-matrix-2/vec3 ../core/libs/gl-matrix-2/vec3f64 ../layers/Layer ../support/basemapUtils ../views/3d/support/mathUtils ../webdoc/support/Thumbnail ./Environment ./Lighting ./support/Description ./support/SlideGround ./support/SlideVisibleLayer ./support/Title".split(" "),
function(T,U,w,G,g,m,h,H,I,J,x,K,L,M,n,f,p,y,r,N,z,O,k,A,P,q,B,C,l){function D(d){if("building-scene"===d.type||"map-image"===d.type)return d.allSublayers}function E(d){if(d=D(d))return d.filter(function(b){return b.visible}).map(function(b){return b.id}).toArray()}function Q(d,b){d=b-d;d>F&&(d-=t);d<-F&&(d+=t);return d}var R=0,u=x.ofType(C.default),S=M.getLogger("esri.webscene.Slide"),t=86400,F=43200;return function(d){function b(a){a=d.call(this,a)||this;a._applyToController=null;a.id=Date.now().toString(16)+
"-slide-"+R++;a.title=new l.default;a.description=new q.default;a.thumbnail=new k.default;a.viewpoint=null;a.basemap=null;a.ground=null;a.environment=new A;a.visibleLayers=new u;return a}G(b,d);b.prototype.castTitle=function(a){return"string"===typeof a?new l.default({text:a}):p.ensureType(l.default,a)};b.prototype.castDescription=function(a){return"string"===typeof a?new q.default({text:a}):p.ensureType(q.default,a)};b.prototype.castThumbnail=function(a){return"string"===typeof a?new k.default({url:a}):
p.ensureType(k.default,a)};b.prototype.castBasemap=function(a){return z.ensureType(a)};Object.defineProperty(b.prototype,"visibleLayers",{set:function(a){this._set("visibleLayers",K.referenceSetter(a,this._get("visibleLayers"),u))},enumerable:!0,configurable:!0});b.prototype.castVisibleLayers=function(a){return a&&"function"===typeof a.map?a.map(function(a){if("string"===typeof a)return{id:a};if(a instanceof N){var c=E(a);return{id:a.id,sublayerIds:c}}if(a.id)return{id:a.id,sublayerIds:a.sublayerIds};
S.warn('Invalid visible layer, expected { id }, Layer or "id"');return a}):null};b.prototype.clone=function(){return new this.constructor({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||
null})};b.prototype._updateVisibleLayersFrom=function(a){var b=this,c=[];return n.eachAlways(this._allLayers(a.map).map(function(b){return a.whenLayerView(b).then(function(a){if(a.visible){var e=E(b);c.push(new C.default({id:a.layer.id,sublayerIds:e}))}})}).toArray()).then(function(){b.visibleLayers.removeAll();b.visibleLayers.addMany(c)})};b.prototype.updateFrom=function(a,b){var c=this;b={screenshot:w({format:"jpeg",quality:80,width:120,height:75,disableSlice:!0},b&&b.screenshot)};return a.when(function(){c.viewpoint=
a.viewpoint.clone();c.environment.lighting=P.prototype.clone.apply(a.environment.lighting);c.basemap=a.map.basemap&&a.map.basemap.clone()||null;c.ground=a.map.ground?B.default.fromGround(a.map.ground):null;return c._updateVisibleLayersFrom(a)}).then(function(){return a.takeScreenshot(b.screenshot)}).then(function(a){c.thumbnail=new k.default({url:a.dataUrl});return c})};b.prototype.applyTo=function(a,b){return h(this,void 0,void 0,function(){var c,e,d;return m(this,function(v){this._applyToController&&
this._applyToController.abort();this._applyToController=c=n.createAbortController();n.onAbortOrThrow(b,function(){return c.abort()});e=w({animate:!0},b,{signal:this._applyToController.signal});d=n.createDeferred(function(){return c.abort()});this._applyTo(a,e,c).then(d.resolve,d.reject);return[2,d.promise]})})};b.prototype._applyTo=function(a,b,c){return h(this,void 0,void 0,function(){var e,d=this;return m(this,function(v){switch(v.label){case 0:return[4,J.result(function(){return h(d,void 0,void 0,
function(){return m(this,function(c){switch(c.label){case 0:return[4,this._applyBasemap(a,b)];case 1:return c.sent(),this._applyLayerVisibility(a),this._applyGround(a),[4,this._applyViewpoint(a,b)];case 2:return c.sent(),[2]}})})}())];case 1:e=v.sent();this._applyToController===c&&(this._applyToController=null);if(!1===e.ok)throw e.error;return[2,this]}})})};b.prototype._applyBasemap=function(a,b){return h(this,void 0,void 0,function(){var c;return m(this,function(e){switch(e.label){case 0:if(!this.basemap)return[3,
5];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.basemap.load(b)];case 2:return e.sent(),[3,4];case 3:c=e.sent();if(n.isAbortError(c))throw c;return[3,4];case 4:a.map.basemap=z.clonePreservingTiledLayers(this.basemap,a.map.basemap),e.label=5;case 5:return[2]}})})};b.prototype._applyGround=function(a){this.ground&&(a.map.ground=this.ground.cloneAndApplyTo(a.map.ground))};b.prototype._allLayers=function(a){var b=new x;this._collectLayers(a,b);this._collectLayers(a.ground,b);return b};b.prototype._collectLayers=
function(a,b){var c=this;a.layers.forEach(function(a){b.add(a);a.layers&&c._collectLayers(a,b)})};b.prototype._applyLayerVisibility=function(a){var b=this;this.visibleLayers&&this._allLayers(a.map).forEach(function(a){var c=b.visibleLayers.find(function(b){return b.id===a.id});a.visible=null!=c;var e=c&&c.sublayerIds,c=D(a);e&&c&&c.forEach(function(a){return a.visible=0<=e.indexOf(a.id)})})};b.prototype._applyViewpoint=function(a,b){return h(this,void 0,void 0,function(){return m(this,function(c){switch(c.label){case 0:if(!this.viewpoint||
b.ignoreViewpoint)return[3,5];this.viewpoint.camera.fov=a.camera.fov;return b.animate&&this.get("environment.lighting.date")?[4,this._animateToLighting(a,b)]:[3,2];case 1:return c.sent(),[2];case 2:if(!b.animate)return[3,4];a.environment.updateLighting(this.environment.lighting.clone());return[4,a.goTo(this.viewpoint,b)];case 3:c.sent(),c.label=4;case 4:a.viewpoint=this.viewpoint,c.label=5;case 5:return a.environment.updateLighting(this.environment.lighting.clone()),[2]}})})};b.prototype._animateToLighting=
function(a,b){return h(this,void 0,void 0,function(){var c,e,d,f=this;return m(this,function(g){c=null;"global"===a.viewingMode&&(c=this._animateLightingWithCamera(a));a.environment.lighting.cameraTrackingEnabled=!1;a.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled;null!=this.environment.lighting.displayUTCOffset&&(a.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);e=a.goTo(this.viewpoint,b);d=function(){c&&c.remove();a.environment.lighting.cameraTrackingEnabled=
!0};return[2,e.then(function(){a.environment.updateLighting(f.environment.lighting.clone());d()},function(a){d();throw a;})]})})};b.prototype._getTime=function(a){var b=a.getTime();a=3600*a.getUTCHours()+60*a.getUTCMinutes()+a.getUTCSeconds();return[b,a]};b.prototype._setTime=function(a,b,c){a.setTime(b);a.setUTCHours(c/3600);a.setUTCMinutes(c%3600/60);a.setUTCSeconds(c%3600%60);return a};b.prototype._animateLightingWithCamera=function(a){var b=this,c=this._getTime(new Date(a.environment.lighting.date.toString())),
d=c[0],f=c[1],c=this._getTime(this.environment.lighting.date),g=c[0],m=Q(f,c[1]),h=a.renderCoordsHelper,k=r.vec3f64.create();h.toRenderCoords(a.camera.position,k);var n=r.vec3f64.create();h.toRenderCoords(this.viewpoint.camera.position,n);var l=r.vec3f64.create(),q=new Date;return a.watch("camera",function(c){h.toRenderCoords(c.position,l);var e=y.vec3.squaredDistance(k,l),p=y.vec3.squaredDistance(n,l);c=0;0!==e+p&&(c=e/(e+p));e=d+(g-d)*c;c=O.moduloPositive(f+m*c,t);a.environment.lighting.date=b._setTime(q,
e,c)})};b.createFrom=function(a,b){return(new this).updateFrom(a,b)};g([f.property({type:String,json:{write:{isRequired:!0}}})],b.prototype,"id",void 0);g([f.property({type:l.default,json:{default:function(){return new l.default({text:""})},write:{isRequired:!0}}})],b.prototype,"title",void 0);g([f.cast("title")],b.prototype,"castTitle",null);g([f.property({type:q.default,json:{write:{overridePolicy:function(a){return{enabled:!(!a||!a.text)}}}}})],b.prototype,"description",void 0);g([f.cast("description")],
b.prototype,"castDescription",null);g([f.property({type:k.default,json:{default:function(){return new k.default({url:""})},write:{isRequired:!0}}})],b.prototype,"thumbnail",void 0);g([f.cast("thumbnail")],b.prototype,"castThumbnail",null);g([f.property({type:I,nonNullable:!0,json:{write:{isRequired:!0}}})],b.prototype,"viewpoint",void 0);g([f.property({type:H,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],b.prototype,"basemap",void 0);g([f.cast("basemap")],b.prototype,"castBasemap",null);
g([f.property({type:B.default,json:{write:!0}})],b.prototype,"ground",void 0);g([f.property({type:u,json:{write:{isRequired:!0}}})],b.prototype,"visibleLayers",null);g([f.cast("visibleLayers")],b.prototype,"castVisibleLayers",null);g([f.property({type:A,json:{write:!0}})],b.prototype,"environment",void 0);return b=g([f.subclass("esri.webscene.Slide")],b)}(f.declared(L.JSONSupport))});